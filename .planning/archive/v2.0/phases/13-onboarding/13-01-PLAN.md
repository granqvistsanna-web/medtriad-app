---
phase: 13-onboarding
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - medtriad/app/_layout.tsx
  - medtriad/app/onboarding.tsx
  - medtriad/components/onboarding/PaginationDots.tsx
autonomous: true

must_haves:
  truths:
    - "User with gamesPlayed = 0 sees onboarding on app launch"
    - "User with gamesPlayed > 0 goes directly to tabs"
    - "Onboarding has 2-3 swipeable screens"
    - "User can skip onboarding at any point via visible skip button"
    - "Mascot appears on onboarding screens"
    - "Get Started button navigates to main app"
  artifacts:
    - path: "medtriad/app/_layout.tsx"
      provides: "Stack.Protected guards for conditional routing"
      contains: "Stack.Protected"
    - path: "medtriad/app/onboarding.tsx"
      provides: "Fullscreen onboarding with horizontal pagination"
      min_lines: 80
    - path: "medtriad/components/onboarding/PaginationDots.tsx"
      provides: "Animated dot indicators for current page"
      exports: ["PaginationDots"]
  key_links:
    - from: "medtriad/app/_layout.tsx"
      to: "useStats"
      via: "isNewUser and loading check"
      pattern: "isNewUser.*loading"
    - from: "medtriad/app/onboarding.tsx"
      to: "router.replace"
      via: "skip and get started navigation"
      pattern: "router\\.replace.*tabs"
---

<objective>
Implement onboarding flow for new users with 2-3 swipeable screens explaining triads and scoring.

Purpose: New users need context about what medical triads are and how scoring works before their first quiz.

Output:
- Modified root layout with Stack.Protected guards
- New onboarding.tsx screen with horizontal FlatList pagination
- PaginationDots component for page indicators
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-onboarding/13-RESEARCH.md

# Key existing files
@medtriad/app/_layout.tsx
@medtriad/hooks/useStats.ts
@medtriad/components/home/TriMascot.tsx
@medtriad/components/ui/Button.tsx
@medtriad/constants/theme.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Root Layout with Stack.Protected Guards</name>
  <files>medtriad/app/_layout.tsx</files>
  <action>
Modify the root layout to conditionally route new users to onboarding:

1. Import useStats hook at the top
2. Inside RootLayout component, call useStats() to get { isNewUser, loading }
3. Return null while loading to prevent flash of wrong screen
4. Wrap Stack.Screen entries with Stack.Protected:
   - `<Stack.Protected guard={isNewUser}>` for onboarding screen
   - `<Stack.Protected guard={!isNewUser}>` for (tabs) screen
5. Add Stack.Screen for "onboarding" with headerShown: false
6. Keep quiz and modal screens outside Protected (always accessible)

IMPORTANT: The guard prop controls when the route is accessible:
- `guard={isNewUser}` means: show this route when isNewUser is true
- `guard={!isNewUser}` means: show this route when isNewUser is false

This ensures:
- New users (gamesPlayed = 0) see onboarding first
- Returning users skip directly to tabs
- No flash because we return null during loading
  </action>
  <verify>
TypeScript compiles: `cd medtriad && npx tsc --noEmit`
  </verify>
  <done>
Root layout guards onboarding route for new users only, returns null during loading to prevent flash
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Onboarding Screen with Pagination</name>
  <files>medtriad/app/onboarding.tsx</files>
  <action>
Create new onboarding screen with horizontal FlatList pagination:

1. Define PAGES array with 3 screens:
   - Page 1: "Welcome to MedTriads" - introduce the app concept
     - Mascot mood: 'neutral'
     - Subtitle: "Test your knowledge of classic medical triads"
   - Page 2: "How It Works" - explain gameplay
     - Mascot mood: 'happy'
     - Subtitle: "See three findings, name the diagnosis. Quick 10-question rounds."
   - Page 3: "Ready to Start?" - call to action
     - Mascot mood: 'streak'
     - Subtitle: "Build streaks, climb tiers, master all 15 triads!"

2. Use FlatList with:
   - horizontal={true}
   - pagingEnabled={true}
   - showsHorizontalScrollIndicator={false}
   - bounces={false}
   - scrollEventThrottle={16}
   - onScroll using useAnimatedScrollHandler to track scrollX

3. Create AnimatedFlatList: `Animated.createAnimatedComponent(FlatList)`

4. Page layout (each page fills screen width):
   - Center content vertically
   - TriMascot at top (size="xl")
   - Title below mascot (Typography.title, centered)
   - Subtitle below title (Typography.body, textSecondary, centered)
   - Use FadeInUp.delay(index * Durations.stagger).duration(Durations.normal).springify() for entry

5. Skip button:
   - Position: absolute, top right (top: insets.top + Spacing.sm, right: Spacing.lg)
   - Text: "Skip" (Typography.label, textSecondary color)
   - zIndex: 10 to stay above content
   - onPress: router.replace('/(tabs)')

6. Bottom section (below FlatList, in SafeArea):
   - PaginationDots component (create in Task 3)
   - "Get Started" Button on last page only:
     - Track currentPage via onMomentumScrollEnd or derive from scrollX
     - Show Button component (label="Get Started", icon="play.fill")
     - onPress: router.replace('/(tabs)')
     - Animate in with FadeInUp when on last page

7. Use useSafeAreaInsets() for safe areas
8. Use useWindowDimensions() for page width (NOT Dimensions.get)
  </action>
  <verify>
TypeScript compiles: `cd medtriad && npx tsc --noEmit`
File exists: `ls medtriad/app/onboarding.tsx`
  </verify>
  <done>
Onboarding screen renders 3 swipeable pages with mascot, title, subtitle, skip button, pagination dots, and Get Started button on last page
  </done>
</task>

<task type="auto">
  <name>Task 3: Create PaginationDots Component</name>
  <files>medtriad/components/onboarding/PaginationDots.tsx</files>
  <action>
Create animated pagination dots component:

1. Create directory: `mkdir -p medtriad/components/onboarding`

2. Create PaginationDots.tsx with:

Props interface:
```typescript
type PaginationDotsProps = {
  scrollX: SharedValue<number>;
  count: number;
  width: number;
};
```

3. Internal Dot component:
   - Takes index, scrollX, width props
   - Uses useAnimatedStyle with interpolate:
     - inputRange: [(index-1)*width, index*width, (index+1)*width]
     - dotWidth: interpolate to [8, 24, 8] (active dot expands)
     - opacity: interpolate to [0.4, 1, 0.4]
     - Use Extrapolation.CLAMP
   - Style: height 8, borderRadius Radius.full, backgroundColor colors.primary, marginHorizontal 4

4. PaginationDots component:
   - Render a row of Dot components
   - flexDirection: 'row', justifyContent: 'center', alignItems: 'center'
   - Map over Array.from({ length: count }) to render dots

5. Export PaginationDots as named export
  </action>
  <verify>
TypeScript compiles: `cd medtriad && npx tsc --noEmit`
File exists: `ls medtriad/components/onboarding/PaginationDots.tsx`
  </verify>
  <done>
PaginationDots component animates dot width and opacity based on scroll position
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. TypeScript compiles without errors:
   ```bash
   cd medtriad && npx tsc --noEmit
   ```

2. App runs without crashes:
   ```bash
   cd medtriad && npx expo start
   ```

3. Manual verification:
   - Clear AsyncStorage to simulate new user
   - Launch app - should see onboarding
   - Swipe through 3 pages
   - Dots animate correctly
   - Skip button visible on all pages
   - Get Started button appears on last page
   - Both skip and Get Started navigate to home
   - On second launch - should go directly to tabs (after playing a quiz)
</verification>

<success_criteria>
- [ ] Root layout uses Stack.Protected to guard onboarding route
- [ ] Onboarding screen has 3 horizontal pages with FlatList pagination
- [ ] Each page shows mascot, title, and subtitle
- [ ] Skip button visible in top-right on all pages
- [ ] Pagination dots animate based on scroll position
- [ ] Get Started button appears on final page
- [ ] Both skip and Get Started navigate to main app via router.replace
- [ ] No flash of wrong screen during loading
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-onboarding/13-01-SUMMARY.md`
</output>
