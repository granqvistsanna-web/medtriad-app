---
phase: 01-data-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - medtriad/services/triads.ts
  - medtriad/services/question-generator.ts
autonomous: true

must_haves:
  truths:
    - "Question generator produces 4 answer options (1 correct, 3 distractors)"
    - "Distractors prefer same-category conditions"
    - "No duplicate distractors appear in a single question's options"
    - "Questions can be generated for any triad in the dataset"
  artifacts:
    - path: "medtriad/services/triads.ts"
      provides: "Triad data access functions"
      exports: ["getAllTriads", "getTriadsByCategory"]
    - path: "medtriad/services/question-generator.ts"
      provides: "Quiz question generation"
      exports: ["generateQuestion", "generateQuestionSet"]
  key_links:
    - from: "medtriad/services/triads.ts"
      to: "medtriad/data/triads.json"
      via: "JSON import"
      pattern: "import.*triads\\.json"
    - from: "medtriad/services/question-generator.ts"
      to: "medtriad/services/triads.ts"
      via: "getAllTriads import"
      pattern: "import.*getAllTriads"
    - from: "medtriad/services/question-generator.ts"
      to: "medtriad/utils/shuffle.ts"
      via: "shuffle import"
      pattern: "import.*shuffle"
---

<objective>
Create the question generation service that produces valid quiz questions with same-category-preferred distractors.

Purpose: Transform static triad data into interactive quiz questions. This is the core algorithm that makes the quiz educational by selecting plausible wrong answers from the same medical category.

Output: Working question generator that produces QuizQuestion objects with 4 options, no duplicates, and category-aware distractor selection.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-data-foundation/01-RESEARCH.md

# Dependencies from Plan 01 (must exist)
@medtriad/types/triad.ts
@medtriad/types/question.ts
@medtriad/data/triads.json
@medtriad/utils/shuffle.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create triad data service</name>
  <files>
    medtriad/services/triads.ts
  </files>
  <action>
Create the services directory and triads.ts:

**medtriad/services/triads.ts:**
```typescript
import triadsData from '@/data/triads.json';
import { Triad, TriadCategory } from '@/types';

// Type assertion for imported JSON
const triads = triadsData.triads as Triad[];

/**
 * Get all triads from the dataset
 */
export function getAllTriads(): Triad[] {
  return triads;
}

/**
 * Get triads filtered by category
 */
export function getTriadsByCategory(category: TriadCategory): Triad[] {
  return triads.filter(t => t.category === category);
}

/**
 * Get a random subset of triads
 * Used for generating a round of questions
 */
export function getRandomTriads(count: number): Triad[] {
  // Import shuffle locally to avoid circular dependency issues
  const { shuffle } = require('@/utils/shuffle');
  const shuffled = shuffle([...triads]);
  return shuffled.slice(0, Math.min(count, triads.length));
}
```

**Key points:**
- Import JSON using @/ path alias
- Cast to Triad[] type for type safety
- Simple, pure functions
- No state management (stateless service)
  </action>
  <verify>
Run `npx tsc --noEmit` from medtriad directory - should pass with no errors
  </verify>
  <done>
triads.ts exports getAllTriads, getTriadsByCategory, and getRandomTriads functions; JSON imports without error
  </done>
</task>

<task type="auto">
  <name>Task 2: Create question generator service</name>
  <files>
    medtriad/services/question-generator.ts
  </files>
  <action>
Create the question-generator.ts service:

**medtriad/services/question-generator.ts:**

Implement three exported functions:

1. **generateQuestion(correctTriad: Triad): QuizQuestion**
   - Call selectDistractors to get 3 distractor triads
   - Create QuizOption array with correct answer + 3 distractors
   - Shuffle the options array so correct answer isn't always first
   - Return QuizQuestion object with:
     - id: `q-${correctTriad.id}-${Date.now()}`
     - triad: correctTriad
     - displayFindings: findings joined with " + " separator
     - options: shuffled array of 4 QuizOption objects

2. **generateQuestionSet(count: number): QuizQuestion[]**
   - Get all triads and shuffle them
   - Take first `count` triads (or all if fewer exist)
   - Map each to a question using generateQuestion
   - This ensures no duplicate triads in a single quiz round

3. **selectDistractors(correctTriad: Triad, count: number): Triad[]** (internal)
   - Get all triads from triads service
   - Partition into same-category (excluding correct) and other-category
   - Use Set to track used IDs (starting with correctTriad.id)
   - First: shuffle same-category and add up to `count` distractors
   - Then: if still need more, shuffle other-category and fill remaining
   - Return array of `count` distractor triads (no duplicates)

**Implementation details:**
- Use @/ path aliases for imports
- Import shuffle from @/utils/shuffle
- Import types from @/types
- Import getAllTriads from @/services/triads
- Add JSDoc comments to exported functions
- formatFindings helper: `findings.join(' + ')`

**Critical for DATA-02 and DATA-03:**
- Same-category preference: Fill from sameCategory pool first
- No duplicates: Track usedIds Set, skip any triad already used
  </action>
  <verify>
1. Run `npx tsc --noEmit` from medtriad directory
2. Create a quick test script or use Node REPL to verify:
   - Generate a question and confirm 4 options exist
   - Confirm exactly 1 option has isCorrect: true
   - Confirm no duplicate condition names in options
  </verify>
  <done>
generateQuestion returns QuizQuestion with 4 options (1 correct, 3 distractors); generateQuestionSet returns array of unique questions; distractors prefer same category; no duplicates in options
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Type compilation:** `cd medtriad && npx tsc --noEmit` passes

2. **Question generation test:**
   Create a simple test by temporarily adding to any file or using REPL:
   ```typescript
   import { generateQuestion, generateQuestionSet } from '@/services/question-generator';
   import { getAllTriads } from '@/services/triads';

   // Test single question
   const triads = getAllTriads();
   const question = generateQuestion(triads[0]);
   console.log('Options count:', question.options.length); // Should be 4
   console.log('Correct count:', question.options.filter(o => o.isCorrect).length); // Should be 1

   // Check for duplicates
   const conditions = question.options.map(o => o.condition);
   const uniqueConditions = new Set(conditions);
   console.log('No duplicates:', conditions.length === uniqueConditions.size); // Should be true

   // Test question set
   const questionSet = generateQuestionSet(10);
   console.log('Question set size:', questionSet.length); // Should be 10
   ```

3. **Category preference verification:**
   - For a cardiology triad, distractors should mostly be cardiology
   - Only falls back to other categories if <3 same-category triads available

4. **File structure:**
   ```
   medtriad/
     services/
       triads.ts
       question-generator.ts
   ```
</verification>

<success_criteria>
- TypeScript compiles without errors
- generateQuestion returns QuizQuestion with exactly 4 options
- Exactly 1 option is marked isCorrect: true
- No duplicate conditions in a question's options
- Distractors prefer same-category (when available)
- generateQuestionSet(10) returns 10 unique questions
- All imports use @/* path alias
</success_criteria>

<output>
After completion, create `.planning/phases/01-data-foundation/01-02-SUMMARY.md`
</output>
