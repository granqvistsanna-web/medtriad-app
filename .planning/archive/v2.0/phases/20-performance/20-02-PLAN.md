---
phase: 20-performance
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - medtriad/app/_layout.tsx
  - medtriad/components/home/TriMascot.tsx
  - medtriad/components/LoadingSkeleton.tsx
autonomous: true

must_haves:
  truths:
    - "Mascot images preloaded during splash screen"
    - "Root layout shows immediate feedback instead of blank screen"
    - "No mascot image flash on first render"
  artifacts:
    - path: "medtriad/app/_layout.tsx"
      provides: "Image preloading and skeleton loading state"
      contains: "Image.prefetch"
    - path: "medtriad/components/home/TriMascot.tsx"
      provides: "expo-image instead of RN Image"
      contains: "from 'expo-image'"
    - path: "medtriad/components/LoadingSkeleton.tsx"
      provides: "Loading placeholder component"
      contains: "LoadingSkeleton"
  key_links:
    - from: "medtriad/app/_layout.tsx"
      to: "expo-image"
      via: "prefetch call"
      pattern: "Image\\.prefetch"
    - from: "medtriad/components/home/TriMascot.tsx"
      to: "expo-image"
      via: "import"
      pattern: "import.*Image.*expo-image"
---

<objective>
Preload mascot images and improve loading UX for faster perceived performance

Purpose: Currently the root layout returns null while loading stats, creating a blank screen delay. Mascot images use standard RN Image without preloading, potentially causing flash on first render. Preloading images during splash and showing immediate skeleton feedback improves perceived launch time.

Output: Preloaded mascot images, expo-image usage in TriMascot, skeleton loading state in root layout
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-performance/20-RESEARCH.md

@medtriad/app/_layout.tsx
@medtriad/components/home/TriMascot.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LoadingSkeleton component</name>
  <files>medtriad/components/LoadingSkeleton.tsx</files>
  <action>
Create a simple loading skeleton component that shows immediate feedback during app initialization:

```typescript
import { View, StyleSheet, ActivityIndicator } from 'react-native';
import { Colors } from '@/constants/theme';

export function LoadingSkeleton() {
  const colors = Colors.light;

  return (
    <View style={[styles.container, { backgroundColor: colors.background }]}>
      <ActivityIndicator size="large" color={colors.primary} />
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    alignItems: 'center',
    justifyContent: 'center',
  },
});
```

This provides immediate visual feedback instead of a blank screen. Uses the app's primary teal color for brand consistency.

Note: A more elaborate skeleton (shimmer placeholders) would be over-engineering for the brief loading period (~200-500ms).
  </action>
  <verify>
File exists at medtriad/components/LoadingSkeleton.tsx with LoadingSkeleton export
  </verify>
  <done>LoadingSkeleton component created with centered activity indicator</done>
</task>

<task type="auto">
  <name>Task 2: Switch TriMascot to expo-image</name>
  <files>medtriad/components/home/TriMascot.tsx</files>
  <action>
Replace React Native Image with expo-image for better caching and preloading support:

1. Update imports:
```typescript
// Before
import { Image, StyleSheet, View } from 'react-native';

// After
import { StyleSheet, View } from 'react-native';
import { Image } from 'expo-image';
```

2. Update the Image component usage (around line 179):
```typescript
// Before
<Image
  source={imageSource}
  style={{
    width: pixelSize,
    height: pixelSize,
  }}
  resizeMode="contain"
/>

// After
<Image
  source={imageSource}
  style={{
    width: pixelSize,
    height: pixelSize,
  }}
  contentFit="contain"
  cachePolicy="memory-disk"
/>
```

Key changes:
- expo-image uses `contentFit` instead of `resizeMode`
- Add `cachePolicy="memory-disk"` for optimal caching
- expo-image is already installed (package.json shows expo-image: ~3.0.11)
  </action>
  <verify>
Run `grep -n "expo-image" medtriad/components/home/TriMascot.tsx` - should show import
Mascot displays correctly on Home screen (same visual appearance)
  </verify>
  <done>TriMascot uses expo-image with cachePolicy for better caching</done>
</task>

<task type="auto">
  <name>Task 3: Add image preloading to root layout</name>
  <files>medtriad/app/_layout.tsx</files>
  <action>
Update root layout to preload mascot images during splash and show skeleton while loading:

1. Add imports at top:
```typescript
import { useEffect, useState } from 'react';
import { Image } from 'expo-image';
import * as SplashScreen from 'expo-splash-screen';
import { LoadingSkeleton } from '@/components/LoadingSkeleton';
```

2. Add image preloading constants (before RootLayout function):
```typescript
// Keep splash visible during initialization
SplashScreen.preventAutoHideAsync();

// All mascot images to preload
const MASCOT_IMAGES = [
  require('@/assets/images/tri-neutral.png'),
  require('@/assets/images/tri-success.png'),
  require('@/assets/images/tri-lvl1.png'),
  require('@/assets/images/tri-lvl2.png'),
  require('@/assets/images/tri-lvl4.png'),
  require('@/assets/images/tri-lvl5.png'),
  require('@/assets/images/tri-lvl6.png'),
  require('@/assets/images/tri-chill.png'),
  require('@/assets/images/tri-thinking.png'),
  require('@/assets/images/tri-share.png'),
];
```

3. Update RootLayout function:
```typescript
export default function RootLayout() {
  const { isNewUser, loading: statsLoading } = useStats();
  const [imagesLoaded, setImagesLoaded] = useState(false);

  // Preload mascot images
  useEffect(() => {
    async function preloadImages() {
      try {
        await Image.prefetch(MASCOT_IMAGES);
        setImagesLoaded(true);
      } catch (error) {
        // Images will load on-demand if prefetch fails
        console.warn('Image prefetch failed:', error);
        setImagesLoaded(true);
      }
    }
    preloadImages();
  }, []);

  // Hide splash when both stats and images are ready
  useEffect(() => {
    if (!statsLoading && imagesLoaded) {
      SplashScreen.hideAsync();
    }
  }, [statsLoading, imagesLoaded]);

  // Show skeleton while loading (not blank screen)
  if (statsLoading || !imagesLoaded) {
    return <LoadingSkeleton />;
  }

  // ... rest of component unchanged
}
```

This ensures:
- Splash stays visible during image preload
- Shows branded skeleton instead of blank screen if splash hides early
- Images are cached before Home screen renders
- Graceful fallback if prefetch fails
  </action>
  <verify>
1. Run `grep -n "prefetch" medtriad/app/_layout.tsx` - should show Image.prefetch usage
2. Run `grep -n "LoadingSkeleton" medtriad/app/_layout.tsx` - should show import and usage
3. Restart app fresh - no blank screen visible, mascot appears immediately without flash
  </verify>
  <done>Root layout preloads images during splash and shows skeleton during loading</done>
</task>

</tasks>

<verification>
1. Run `ls medtriad/components/LoadingSkeleton.tsx` - file exists
2. Run `grep -n "expo-image" medtriad/components/home/TriMascot.tsx` - shows import
3. Run `grep -n "prefetch" medtriad/app/_layout.tsx` - shows prefetch call
4. Manual: Cold start app - splash visible, then content appears (no blank flash)
5. Manual: Navigate to Home - mascot appears immediately without flicker
6. Manual: Play quiz to results - mascot images switch smoothly
</verification>

<success_criteria>
- LoadingSkeleton component exists and displays activity indicator
- TriMascot uses expo-image with memory-disk cache policy
- Root layout preloads mascot images during splash
- Root layout shows skeleton instead of null while loading
- No visible image flash on first mascot render
</success_criteria>

<output>
After completion, create `.planning/phases/20-performance/20-02-SUMMARY.md`
</output>
