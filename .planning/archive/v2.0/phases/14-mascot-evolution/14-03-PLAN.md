---
phase: 14-mascot-evolution
plan: 03
type: execute
wave: 3
depends_on: ["14-02"]
files_modified:
  - medtriad/components/home/TriMascot.tsx
  - medtriad/app/(tabs)/index.tsx
autonomous: true

must_haves:
  truths:
    - "Home screen shows glow effect on mascot when pendingTierUp exists"
    - "Glow effect clears after being shown"
    - "User who missed tier-up on Results sees celebration glow on Home"
  artifacts:
    - path: "medtriad/components/home/TriMascot.tsx"
      provides: "tierUp mood with glow animation"
      contains: "tierUp"
    - path: "medtriad/app/(tabs)/index.tsx"
      provides: "Checks pendingTierUp and shows glow"
      contains: "pendingTierUp"
  key_links:
    - from: "medtriad/app/(tabs)/index.tsx"
      to: "medtriad/components/home/TriMascot.tsx"
      via: "mood='tierUp' prop"
      pattern: "mood.*tierUp"
    - from: "medtriad/app/(tabs)/index.tsx"
      to: "medtriad/hooks/useStats.ts"
      via: "clearPendingTierUp call"
      pattern: "clearPendingTierUp"
---

<objective>
Implement catch-up celebration on Home screen for users who missed the tier-up moment, showing a glow effect on the mascot.

Purpose: Ensure users never miss their tier-up achievement, even if app was closed during Results
Output: Home screen shows glow on mascot when pendingTierUp exists, then clears the flag
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-mascot-evolution/14-RESEARCH.md
@.planning/phases/14-mascot-evolution/14-CONTEXT.md
@.planning/phases/14-mascot-evolution/14-01-SUMMARY.md
@.planning/phases/14-mascot-evolution/14-02-SUMMARY.md
@medtriad/components/home/TriMascot.tsx
@medtriad/app/(tabs)/index.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tierUp mood with glow animation to TriMascot</name>
  <files>medtriad/components/home/TriMascot.tsx</files>
  <action>
1. Update MascotMood type to include 'tierUp':

```typescript
export type MascotMood = 'neutral' | 'happy' | 'reassuring' | 'streak' | 'tierUp';
```

2. Update the glow animation effect in useEffect to handle both 'streak' and 'tierUp' moods. For 'tierUp', run the glow animation 3 times then stop (finite celebration):

```typescript
useEffect(() => {
  if (!animate) return;

  // ... existing breathe and float animations ...

  // Glow animation for streak (infinite) or tierUp (finite)
  if (mood === 'streak') {
    glow.value = withRepeat(
      withSequence(
        withTiming(1, { duration: 1000, easing: Easing.inOut(Easing.ease) }),
        withTiming(0.3, { duration: 1000, easing: Easing.inOut(Easing.ease) })
      ),
      -1, // Infinite for streak
      false
    );
  } else if (mood === 'tierUp') {
    // Finite glow for tier-up celebration (3 pulses)
    glow.value = withRepeat(
      withSequence(
        withTiming(1, { duration: 800, easing: Easing.inOut(Easing.ease) }),
        withTiming(0.2, { duration: 800, easing: Easing.inOut(Easing.ease) })
      ),
      3, // Run 3 times then stop
      false
    );
  } else {
    glow.value = withTiming(0, { duration: 300 });
  }
}, [mood, animate]);
```

3. Update glowStyle to show for both 'streak' and 'tierUp':

```typescript
const glowStyle = useAnimatedStyle(() => {
  if (mood !== 'streak' && mood !== 'tierUp') return { opacity: 0 };

  return {
    opacity: interpolate(glow.value, [0, 1], [0, 0.4]),
  };
});
```

4. For 'tierUp' mood, also use the happy image (or tier image if context is home):

```typescript
const getImageSource = () => {
  // Home screen uses tier-specific images
  if (context === 'home' && tier) {
    return TIER_IMAGES[tier as keyof typeof TIER_IMAGES] || TIER_IMAGES[1];
  }
  // Quiz/results continue using mood-based images
  if (masteryLevel >= 10) return triSupermaster;
  if (masteryLevel >= 7) return triMaster;
  if (mood === 'happy' || mood === 'streak' || mood === 'tierUp') return triHappy;
  return triNeutral;
};
```
  </action>
  <verify>TypeScript compiles. TriMascot shows glow animation when mood='tierUp'.</verify>
  <done>TriMascot supports 'tierUp' mood with finite (3 pulse) glow animation.</done>
</task>

<task type="auto">
  <name>Task 2: Show catch-up celebration glow on Home screen</name>
  <files>medtriad/app/(tabs)/index.tsx</files>
  <action>
1. Import clearPendingTierUp from useStats (already using the hook):

```typescript
const {
  // ... existing destructuring ...
  pendingTierUp,
  clearPendingTierUp,
} = useStats();
```

2. Add state to track if we're showing the tier-up glow:

```typescript
const [showTierUpGlow, setShowTierUpGlow] = useState(false);
```

3. Add useEffect to detect pendingTierUp and trigger glow, then clear:

```typescript
useEffect(() => {
  if (pendingTierUp && !showTierUpGlow) {
    setShowTierUpGlow(true);
    // Clear the pending flag after showing glow
    // Delay to let the glow animation complete (3 pulses x 1.6s = ~5s)
    const clearTimer = setTimeout(async () => {
      await clearPendingTierUp();
      setShowTierUpGlow(false);
    }, 5000);
    return () => clearTimeout(clearTimer);
  }
}, [pendingTierUp, showTierUpGlow, clearPendingTierUp]);
```

4. Update getMascotMood function in HeroCard (or pass mood override to HeroCard):

The cleanest approach is to pass a mood override to HeroCard. Update HeroCard props to accept an optional `moodOverride`:

In HeroCard.tsx, add:
```typescript
type HeroCardProps = {
  // ... existing props ...
  moodOverride?: MascotMood;  // Optional override for catch-up celebration
};

// In the component:
const mascotMood = moodOverride ?? getMascotMood(isNewUser, accuracy, dailyStreak);
```

Then in index.tsx, pass moodOverride:
```typescript
<HeroCard
  isNewUser={isNewUser}
  accuracy={accuracy}
  dailyStreak={dailyStreak}
  lastPlayed={lastPlayed}
  delay={Durations.stagger}
  masteryLevel={masteryLevel}
  tier={tier}
  tierProgress={tierProgress}
  onTierPress={handleTierPress}
  moodOverride={showTierUpGlow ? 'tierUp' : undefined}
/>
```

5. Alternatively (simpler), modify HeroCard's getMascotMood to accept the glow state:

Actually, the simplest approach is to add a `showTierUpGlow` prop to HeroCard:

```typescript
// In HeroCard.tsx
type HeroCardProps = {
  // ... existing props ...
  showTierUpGlow?: boolean;
};

// Update mascot mood determination:
const mascotMood = showTierUpGlow
  ? 'tierUp'
  : getMascotMood(isNewUser, accuracy, dailyStreak);
```

Then pass from index.tsx:
```typescript
<HeroCard
  // ... existing props ...
  showTierUpGlow={showTierUpGlow}
/>
```

This is cleaner than moodOverride because it's explicit about what we're doing.
  </action>
  <verify>TypeScript compiles. Home screen shows glow when pendingTierUp exists.</verify>
  <done>Home screen detects pendingTierUp, shows glow on mascot for ~5 seconds, then clears the flag. User sees celebration even if they missed Results.</done>
</task>

<task type="auto">
  <name>Task 3: Clear pendingTierUp after Results celebration</name>
  <files>medtriad/app/quiz/results.tsx</files>
  <action>
When the TierUpCelebration completes on Results screen, clear the pendingTierUp flag so the Home screen doesn't show a duplicate catch-up glow:

1. Get clearPendingTierUp from useStats:

```typescript
const { stats, tier, nextTier, clearPendingTierUp } = useStats();
```

2. Update the TierUpCelebration onComplete callback to clear the flag:

```typescript
<TierUpCelebration
  oldTier={oldTierNumber}
  newTier={newTierNumber}
  newTierName={newTierName}
  onComplete={async () => {
    await clearPendingTierUp();
    setCelebrationComplete(true);
  }}
/>
```

This ensures that if the user saw the tier-up celebration on Results, they won't see the catch-up glow on Home. The catch-up glow only triggers if pendingTierUp still exists when Home loads (meaning they missed Results).
  </action>
  <verify>TypeScript compiles. pendingTierUp is cleared after Results celebration.</verify>
  <done>pendingTierUp cleared after Results celebration completes. Home catch-up glow only shows if user missed Results screen.</done>
</task>

</tasks>

<verification>
1. Run `npx tsc --noEmit` - no TypeScript errors
2. Test normal flow:
   - Complete a game that triggers tier-up
   - See celebration on Results (confetti + mascot transition)
   - Navigate to Home - no glow (pendingTierUp was cleared on Results)
3. Test catch-up flow:
   - Set gamesPlayed to 9 in storage
   - Complete a quiz but force-quit app during Results
   - Reopen app to Home screen
   - Mascot should have glow animation (3 pulses)
   - After ~5 seconds, glow stops and pendingTierUp is cleared
</verification>

<success_criteria>
- TriMascot supports 'tierUp' mood with finite 3-pulse glow animation
- Home screen detects pendingTierUp and passes showTierUpGlow to HeroCard
- Glow animation plays for ~5 seconds then pendingTierUp is cleared
- Results screen clears pendingTierUp after celebration completes
- Users never see duplicate celebrations (either Results OR Home catch-up, not both)
</success_criteria>

<output>
After completion, create `.planning/phases/14-mascot-evolution/14-03-SUMMARY.md`
</output>
