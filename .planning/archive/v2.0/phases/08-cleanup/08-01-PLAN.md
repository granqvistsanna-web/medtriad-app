---
phase: 08-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - medtriad/hooks/useHaptics.ts
  - medtriad/app/quiz/index.tsx
  - medtriad/components/haptic-tab.tsx
  - medtriad/services/triads.ts
  - medtriad/services/stats-storage.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Toggle haptics off in settings disables haptics in quiz"
    - "Toggle haptics off in settings disables haptics in tab bar"
    - "getRandomTriads function no longer exists in triads.ts"
    - "isNewUser function no longer exists in stats-storage.ts"
  artifacts:
    - path: "medtriad/hooks/useHaptics.ts"
      provides: "Haptics hook respecting settings"
      exports: ["useHaptics"]
    - path: "medtriad/app/quiz/index.tsx"
      provides: "Quiz screen using useHaptics"
      contains: "useHaptics"
    - path: "medtriad/components/haptic-tab.tsx"
      provides: "Tab button checking haptics setting"
      contains: "hapticsEnabled"
  key_links:
    - from: "medtriad/hooks/useHaptics.ts"
      to: "medtriad/services/settings-storage.ts"
      via: "loadSettings import"
      pattern: "loadSettings"
    - from: "medtriad/app/quiz/index.tsx"
      to: "medtriad/hooks/useHaptics.ts"
      via: "useHaptics hook"
      pattern: "useHaptics"
    - from: "medtriad/components/haptic-tab.tsx"
      to: "medtriad/services/settings-storage.ts"
      via: "loadSettings import"
      pattern: "loadSettings"
---

<objective>
Create useHaptics hook and wire it throughout the app, then remove orphaned exports.

Purpose: Close tech debt from v1 milestone audit - haptics setting is not respected.
Output: Clean codebase where haptics setting controls all haptic feedback.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Reference implementations:
@medtriad/hooks/useSoundEffects.ts (pattern to follow for useHaptics)
@medtriad/services/settings-storage.ts (settings interface with hapticsEnabled)
@medtriad/app/quiz/index.tsx (line 126 - unconditional Haptics.impactAsync)
@medtriad/components/haptic-tab.tsx (line 12 - unconditional Haptics.impactAsync)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useHaptics hook</name>
  <files>medtriad/hooks/useHaptics.ts</files>
  <action>
Create `useHaptics` hook following the `useSoundEffects` pattern:

1. Import `loadSettings` from `@/services/settings-storage`
2. Import `* as Haptics` from `expo-haptics`
3. Create state for `hapticsEnabled` (default true)
4. Load settings on mount via useEffect
5. Create `triggerHaptic` function that:
   - Takes style parameter (ImpactFeedbackStyle, default Light)
   - Returns early if !hapticsEnabled
   - Calls Haptics.impactAsync with the style
6. Create `refreshSettings` callback similar to useSoundEffects
7. Export { triggerHaptic, hapticsEnabled, refreshSettings }

Pattern to match (from useSoundEffects.ts):
```typescript
export function useHaptics() {
  const [hapticsEnabled, setHapticsEnabled] = useState(true);

  useEffect(() => {
    loadSettings().then((settings) => {
      setHapticsEnabled(settings.hapticsEnabled);
    });
  }, []);

  const triggerHaptic = useCallback((
    style: Haptics.ImpactFeedbackStyle = Haptics.ImpactFeedbackStyle.Light
  ) => {
    if (!hapticsEnabled) return;
    Haptics.impactAsync(style);
  }, [hapticsEnabled]);

  const refreshSettings = useCallback(async () => {
    const settings = await loadSettings();
    setHapticsEnabled(settings.hapticsEnabled);
  }, []);

  return { triggerHaptic, hapticsEnabled, refreshSettings };
}
```
  </action>
  <verify>TypeScript compiles without errors: `cd medtriad && npx tsc --noEmit`</verify>
  <done>useHaptics hook exports triggerHaptic that respects hapticsEnabled setting</done>
</task>

<task type="auto">
  <name>Task 2: Wire useHaptics to quiz and update haptic-tab</name>
  <files>medtriad/app/quiz/index.tsx, medtriad/components/haptic-tab.tsx</files>
  <action>
**In quiz/index.tsx:**
1. Remove direct import of `* as Haptics from 'expo-haptics'`
2. Add import `import { useHaptics } from '@/hooks/useHaptics'`
3. In QuizScreen component, add: `const { triggerHaptic } = useHaptics();`
4. Replace line 126 `Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light)` with `triggerHaptic()`

**In haptic-tab.tsx:**
The HapticTab component cannot use hooks (it's a component that wraps PlatformPressable).
Instead, load settings directly:

1. Add imports:
   - `import { useState, useEffect } from 'react'`
   - `import { loadSettings } from '@/services/settings-storage'`
2. Add state: `const [hapticsEnabled, setHapticsEnabled] = useState(true)`
3. Add useEffect to load settings on mount
4. Wrap the Haptics.impactAsync call with `if (hapticsEnabled)`

Updated component structure:
```typescript
export function HapticTab(props: BottomTabBarButtonProps) {
  const [hapticsEnabled, setHapticsEnabled] = useState(true);

  useEffect(() => {
    loadSettings().then((settings) => {
      setHapticsEnabled(settings.hapticsEnabled);
    });
  }, []);

  return (
    <PlatformPressable
      {...props}
      onPressIn={(ev) => {
        if (process.env.EXPO_OS === 'ios' && hapticsEnabled) {
          Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
        }
        props.onPressIn?.(ev);
      }}
    />
  );
}
```
  </action>
  <verify>TypeScript compiles: `cd medtriad && npx tsc --noEmit`</verify>
  <done>Quiz screen and tab bar both check hapticsEnabled before triggering haptics</done>
</task>

<task type="auto">
  <name>Task 3: Remove orphaned exports</name>
  <files>medtriad/services/triads.ts, medtriad/services/stats-storage.ts</files>
  <action>
**In triads.ts:**
Delete the entire `getRandomTriads` function (lines 25-29):
```typescript
// DELETE THIS:
export function getRandomTriads(count: number): Triad[] {
  const shuffled = shuffle([...triads]);
  return shuffled.slice(0, Math.min(count, triads.length));
}
```

**In stats-storage.ts:**
Delete the entire `isNewUser` function (lines 146-150):
```typescript
// DELETE THIS:
export async function isNewUser(): Promise<boolean> {
  const stats = await loadStats();
  return stats.gamesPlayed === 0;
}
```

Note: The isNewUser logic is already implemented in useStats.ts as a derived value: `const isNewUser = stats?.gamesPlayed === 0;`
  </action>
  <verify>
1. Grep confirms no remaining usage: `grep -r "getRandomTriads" medtriad/` returns only this file
2. Grep confirms no direct import of isNewUser from stats-storage: `grep -r "isNewUser.*stats-storage" medtriad/`
3. TypeScript compiles: `cd medtriad && npx tsc --noEmit`
  </verify>
  <done>getRandomTriads and isNewUser functions removed from service files</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Grep for unconditional `Haptics.impactAsync` in quiz/index.tsx returns no results
3. Grep for unconditional `Haptics.impactAsync` in haptic-tab.tsx returns no results (now conditional)
4. Grep for `getRandomTriads` returns no export/definition (only potential comments)
5. Grep for `isNewUser` in stats-storage.ts returns no export/definition
6. Manual test: Toggle haptics off in Settings -> play quiz -> no haptics fire
</verification>

<success_criteria>
1. useHaptics hook exists and exports triggerHaptic that checks hapticsEnabled
2. quiz/index.tsx uses useHaptics instead of direct Haptics calls
3. haptic-tab.tsx checks hapticsEnabled before calling Haptics
4. getRandomTriads function removed from triads.ts
5. isNewUser function removed from stats-storage.ts
6. All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-cleanup/08-01-SUMMARY.md`
</output>
