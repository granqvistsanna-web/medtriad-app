# Plan 06-04: Settings Screen with Toggles and Share

---
phase: 06-navigation-study-mode
plan: 04
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - medtriad/app/(tabs)/settings.tsx
  - medtriad/services/settings-storage.ts
  - medtriad/components/settings/ToggleRow.tsx
  - medtriad/components/settings/SettingsRow.tsx
autonomous: true

must_haves:
  truths:
    - "User can toggle sound effects on/off"
    - "User can toggle haptic feedback on/off"
    - "Settings persist across app sessions"
    - "User can share app via iOS share sheet"
  artifacts:
    - path: "medtriad/app/(tabs)/settings.tsx"
      provides: "Settings screen with toggles and share"
      min_lines: 60
    - path: "medtriad/services/settings-storage.ts"
      provides: "Settings persistence layer"
      exports: ["loadSettings", "saveSettings", "UserSettings"]
    - path: "medtriad/components/settings/ToggleRow.tsx"
      provides: "Switch toggle row component"
      exports: ["ToggleRow"]
    - path: "medtriad/components/settings/SettingsRow.tsx"
      provides: "Tappable settings row component"
      exports: ["SettingsRow"]
  key_links:
    - from: "medtriad/app/(tabs)/settings.tsx"
      to: "@/services/settings-storage"
      via: "loadSettings, saveSettings imports"
      pattern: "loadSettings|saveSettings"
    - from: "medtriad/app/(tabs)/settings.tsx"
      to: "react-native Share API"
      via: "Share.share call"
      pattern: "Share\\.share"
---

<objective>
Build the Settings screen with sound/haptic toggles, share functionality, and reset stats option.

Purpose: Allow users to customize their experience and share the app with others.
Output: Settings screen with working toggles, share button, reset stats with confirmation, and about section.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-navigation-study-mode/06-CONTEXT.md
@.planning/phases/06-navigation-study-mode/06-RESEARCH.md

# Existing code references
@medtriad/services/stats-storage.ts
@medtriad/constants/theme.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create settings storage service</name>
  <files>medtriad/services/settings-storage.ts</files>
  <action>
Create a new settings storage service following the existing stats-storage pattern.

1. Define UserSettings interface:
```tsx
export interface UserSettings {
  soundEnabled: boolean;
  hapticsEnabled: boolean;
}
```

2. Define defaults:
```tsx
const DEFAULT_SETTINGS: UserSettings = {
  soundEnabled: true,
  hapticsEnabled: true,
};
```

3. Define storage key: `const SETTINGS_KEY = '@medtriad_settings';`

4. Implement loadSettings:
```tsx
export async function loadSettings(): Promise<UserSettings> {
  try {
    const json = await AsyncStorage.getItem(SETTINGS_KEY);
    if (json) {
      return { ...DEFAULT_SETTINGS, ...JSON.parse(json) };
    }
    return DEFAULT_SETTINGS;
  } catch (error) {
    console.error('Failed to load settings:', error);
    return DEFAULT_SETTINGS;
  }
}
```

5. Implement saveSettings:
```tsx
export async function saveSettings(settings: UserSettings): Promise<void> {
  try {
    await AsyncStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
  } catch (error) {
    console.error('Failed to save settings:', error);
  }
}
```

Import AsyncStorage from '@react-native-async-storage/async-storage'.
  </action>
  <verify>File compiles without TypeScript errors.</verify>
  <done>Settings storage service created with load/save functions and UserSettings type.</done>
</task>

<task type="auto">
  <name>Task 2: Create settings row components</name>
  <files>medtriad/components/settings/ToggleRow.tsx, medtriad/components/settings/SettingsRow.tsx</files>
  <action>
Create two reusable settings row components.

**ToggleRow.tsx:**
A row with label and iOS native Switch toggle.

Props:
```tsx
interface ToggleRowProps {
  label: string;
  value: boolean;
  onValueChange: (value: boolean) => void;
}
```

Implementation (follow research Pattern 3):
- Horizontal row with label left, Switch right
- Label: Typography.body, colors.text
- Switch with trackColor customization (false: colors.border, true: colors.primary)
- ios_backgroundColor: colors.border
- DO NOT customize thumbColor (keeps native iOS appearance per research pitfall 3)
- Row has horizontal padding and vertical padding for tap target

**SettingsRow.tsx:**
A tappable row for actions (like Share, Reset Stats).

Props:
```tsx
interface SettingsRowProps {
  label: string;
  onPress: () => void;
  icon?: string;           // SF Symbol name
  destructive?: boolean;   // Red text for destructive actions
}
```

Implementation:
- Pressable row with opacity feedback
- Icon (if provided) on left using IconSymbol
- Label using Typography.body
- Chevron right icon on far right (chevron.right)
- If destructive, label and icon use colors.error
- Row styling same as ToggleRow for consistency
  </action>
  <verify>Components render without errors when imported.</verify>
  <done>ToggleRow and SettingsRow components created with proper iOS styling.</done>
</task>

<task type="auto">
  <name>Task 3: Build Settings screen</name>
  <files>medtriad/app/(tabs)/settings.tsx</files>
  <action>
Replace placeholder Settings screen with full implementation.

**Structure:**
```
Settings (title)

PREFERENCES section
- Sound Effects [Toggle]
- Haptic Feedback [Toggle]

ACTIONS section
- Share App [Row with square.and.arrow.up icon]
- Reset Statistics [Row, destructive style]

ABOUT section
- Version 1.0.0 (Build 1) [Text only, not tappable]
```

**Implementation:**

1. Load settings on mount using useEffect + loadSettings()
2. Track settings state and loading state
3. useFocusEffect to reload settings when tab focused

4. Toggle handlers:
```tsx
const handleSoundToggle = async (value: boolean) => {
  const updated = { ...settings, soundEnabled: value };
  setSettings(updated);
  await saveSettings(updated);
};
```

5. Share handler (follow research Pattern 4):
```tsx
const handleShare = async () => {
  try {
    await Share.share({
      message: 'Learn medical triads with MedTriads! A fun quiz app for medical students.',
      // URL omitted until App Store listing exists
    });
  } catch (error) {
    console.error('Share failed:', error);
  }
};
```

6. Reset stats handler with Alert confirmation (follow research code example):
```tsx
const handleResetStats = () => {
  Alert.alert(
    'Reset Statistics',
    'This will permanently delete all your progress. This action cannot be undone.',
    [
      { text: 'Cancel', style: 'cancel' },
      {
        text: 'Reset',
        style: 'destructive',
        onPress: async () => {
          await clearStats();
          // Optionally show confirmation toast or navigate
        }
      },
    ]
  );
};
```

7. Install expo-application for version display:
   Run: `npx expo install expo-application`
   Then: `import * as Application from 'expo-application';`
   Display: `Application.nativeApplicationVersion` and `Application.nativeBuildVersion`

**Styling:**
- Section headers: Typography.footnote, colors.textMuted, uppercase, left padding
- Section containers: colors.backgroundCard background, border radius
- Spacing between sections using Spacing.lg
- ScrollView wrapper for safety

Import Share and Alert from 'react-native'.
Import clearStats from '@/services/stats-storage'.
  </action>
  <verify>
Run `npx expo start`, navigate to Settings tab:
- Sound and Haptic toggles appear and work
- Toggling persists after leaving and returning to tab
- Share button opens iOS share sheet
- Reset Statistics shows confirmation dialog
- Version number displays at bottom
  </verify>
  <done>Settings screen complete with toggles, share, reset stats, and about section.</done>
</task>

</tasks>

<verification>
- [ ] Settings tab shows Sound Effects and Haptic Feedback toggles
- [ ] Toggling settings persists after app restart (check with `npx expo start` restart)
- [ ] Share App opens native iOS share sheet with message
- [ ] Reset Statistics shows confirmation alert
- [ ] Confirming reset clears stats (verify on Progress screen)
- [ ] Version number displays correctly
- [ ] No TypeScript errors (`npx tsc --noEmit`)
</verification>

<success_criteria>
Settings screen enables users to:
- Toggle sound effects on/off (persisted)
- Toggle haptic feedback on/off (persisted)
- Share app via iOS share sheet
- Reset all statistics with confirmation
- See app version information
</success_criteria>

<output>
After completion, create `.planning/phases/06-navigation-study-mode/06-04-SUMMARY.md`
</output>
