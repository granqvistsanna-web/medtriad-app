---
phase: 05-feedback-persistence
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - medtriad/services/stats-storage.ts
  - medtriad/hooks/useStats.ts
  - medtriad/app/quiz/index.tsx
  - medtriad/app/(tabs)/index.tsx
  - medtriad/components/home/StatRow.tsx
autonomous: true

must_haves:
  truths:
    - "High score persists and displays correctly after app restart"
    - "Daily streak increments on consecutive days and resets after gap"
    - "Daily streak displays on home screen with flame icon"
    - "New High Score badge shows when player beats their record"
    - "Total quizzes completed persists across sessions"
  artifacts:
    - path: "medtriad/services/stats-storage.ts"
      provides: "Persistence layer with highScore and dailyStreak"
      contains: ["highScore", "dailyStreak", "calculateStreak"]
    - path: "medtriad/hooks/useStats.ts"
      provides: "Hook exposing dailyStreak and checkHighScore"
      contains: ["dailyStreak", "checkHighScore"]
    - path: "medtriad/app/quiz/index.tsx"
      provides: "High score check before results navigation"
      contains: "isNewHighScore"
  key_links:
    - from: "medtriad/app/quiz/index.tsx"
      to: "medtriad/services/stats-storage.ts"
      via: "checkHighScore call before navigation"
      pattern: "checkHighScore"
    - from: "medtriad/app/(tabs)/index.tsx"
      to: "medtriad/hooks/useStats.ts"
      via: "dailyStreak from useStats"
      pattern: "dailyStreak"
---

<objective>
Implement data persistence for high score, daily streak, and total quizzes

Purpose: User progress persists across app sessions. High scores motivate improvement, daily streaks encourage consistent practice, and total quizzes track overall engagement.

Output: StoredStats includes highScore, dailyStreak, lastPlayedDate. Home screen displays daily streak. Results screen shows New High Score badge when applicable.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-feedback-persistence/05-CONTEXT.md
@.planning/phases/05-feedback-persistence/05-RESEARCH.md
@medtriad/services/stats-storage.ts
@medtriad/hooks/useStats.ts
@medtriad/app/quiz/index.tsx
@medtriad/app/(tabs)/index.tsx
@medtriad/components/home/StatRow.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend stats-storage with highScore and dailyStreak</name>
  <files>medtriad/services/stats-storage.ts</files>
  <action>
    Add high score and daily streak fields to persistence layer:

    1. Update StoredStats interface:
       ```typescript
       export interface StoredStats {
         totalAnswered: number;
         totalCorrect: number;
         bestStreak: number;      // Best combo in any round
         gamesPlayed: number;
         lastPlayedAt: string | null;
         // NEW FIELDS:
         highScore: number;       // Best total score ever
         dailyStreak: number;     // Consecutive days played
         lastPlayedDate: string | null;  // For streak calculation (toDateString format)
       }
       ```

    2. Update DEFAULT_STATS:
       ```typescript
       const DEFAULT_STATS: StoredStats = {
         totalAnswered: 0,
         totalCorrect: 0,
         bestStreak: 0,
         gamesPlayed: 0,
         lastPlayedAt: null,
         highScore: 0,
         dailyStreak: 0,
         lastPlayedDate: null,
       };
       ```

    3. Add calculateStreak helper function:
       ```typescript
       /**
        * Calculate new streak based on last played date
        * Uses local date strings to handle timezones correctly
        */
       export function calculateStreak(
         currentStreak: number,
         lastPlayedDate: string | null
       ): { newStreak: number; isNewDay: boolean } {
         const today = new Date().toDateString(); // "Sat Jan 18 2026"

         if (lastPlayedDate === null) {
           // First time playing
           return { newStreak: 1, isNewDay: true };
         }

         if (lastPlayedDate === today) {
           // Already played today - streak unchanged
           return { newStreak: currentStreak, isNewDay: false };
         }

         // Check if last played was yesterday
         const yesterday = new Date();
         yesterday.setDate(yesterday.getDate() - 1);
         const yesterdayString = yesterday.toDateString();

         if (lastPlayedDate === yesterdayString) {
           // Consecutive day - increment streak
           return { newStreak: currentStreak + 1, isNewDay: true };
         }

         // Streak broken - reset to 1
         return { newStreak: 1, isNewDay: true };
       }
       ```

    4. Add checkHighScore function:
       ```typescript
       /**
        * Check if new score is a high score and update if so
        * Returns whether it was a new high score
        */
       export async function checkHighScore(newScore: number): Promise<boolean> {
         const stats = await loadStats();
         if (newScore > stats.highScore) {
           await saveStats({ ...stats, highScore: newScore });
           return true;
         }
         return false;
       }
       ```

    5. Update updateAfterQuiz to handle streak:
       ```typescript
       export async function updateAfterQuiz(
         correctCount: number,
         totalQuestions: number,
         maxStreak: number,
         score: number  // ADD this parameter
       ): Promise<StoredStats> {
         const currentStats = await loadStats();

         // Calculate streak
         const { newStreak, isNewDay } = calculateStreak(
           currentStats.dailyStreak,
           currentStats.lastPlayedDate
         );

         const updatedStats: StoredStats = {
           totalAnswered: currentStats.totalAnswered + totalQuestions,
           totalCorrect: currentStats.totalCorrect + correctCount,
           bestStreak: Math.max(currentStats.bestStreak, maxStreak),
           gamesPlayed: currentStats.gamesPlayed + 1,
           lastPlayedAt: new Date().toISOString(),
           // High score updated separately via checkHighScore
           highScore: Math.max(currentStats.highScore, score),
           dailyStreak: newStreak,
           lastPlayedDate: new Date().toDateString(),
         };

         await saveStats(updatedStats);
         return updatedStats;
       }
       ```
  </action>
  <verify>TypeScript compiles: `cd medtriad && npx tsc --noEmit`</verify>
  <done>StoredStats has highScore, dailyStreak, lastPlayedDate. calculateStreak and checkHighScore functions exist.</done>
</task>

<task type="auto">
  <name>Task 2: Update useStats hook and wire to quiz/results</name>
  <files>medtriad/hooks/useStats.ts, medtriad/app/quiz/index.tsx</files>
  <action>
    Update useStats to expose new fields and wire high score check:

    1. In useStats.ts, update StatsData interface:
       ```typescript
       export interface StatsData {
         stats: StoredStats | null;
         loading: boolean;
         isNewUser: boolean;
         accuracy: number;
         masteryLevel: number;
         masteryProgress: number;
         questionsToNextLevel: number;
         levelTitle: string;
         // NEW:
         dailyStreak: number;
         highScore: number;
         refresh: () => Promise<void>;
         recordQuizResult: (correct: number, total: number, streak: number, score: number) => Promise<void>;
         checkHighScore: (score: number) => Promise<boolean>;
       }
       ```

    2. Add derived values in useStats:
       ```typescript
       const dailyStreak = stats?.dailyStreak ?? 0;
       const highScore = stats?.highScore ?? 0;
       ```

    3. Import checkHighScore from stats-storage and wrap it:
       ```typescript
       import {
         StoredStats,
         loadStats,
         updateAfterQuiz,
         getAccuracy,
         checkHighScore as checkHighScoreStorage,
       } from '@/services/stats-storage';

       // In the hook:
       const checkHighScore = useCallback(async (score: number): Promise<boolean> => {
         const isNew = await checkHighScoreStorage(score);
         if (isNew) {
           await fetchStats(); // Refresh to get updated high score
         }
         return isNew;
       }, [fetchStats]);
       ```

    4. Update recordQuizResult to pass score:
       ```typescript
       const recordQuizResult = useCallback(
         async (correct: number, total: number, streak: number, score: number) => {
           const updated = await updateAfterQuiz(correct, total, streak, score);
           setStats(updated);
         },
         []
       );
       ```

    5. Return new fields:
       ```typescript
       return {
         stats,
         loading,
         isNewUser,
         accuracy,
         masteryLevel,
         masteryProgress,
         questionsToNextLevel,
         levelTitle,
         dailyStreak,
         highScore,
         refresh: fetchStats,
         recordQuizResult,
         checkHighScore,
       };
       ```

    6. In quiz/index.tsx, update the auto-advance effect to check high score:
       ```typescript
       const { recordQuizResult, checkHighScore } = useStats();

       // In the auto-advance useEffect:
       useEffect(() => {
         if (status !== 'answered') return;

         const timeout = setTimeout(async () => {
           if (currentIndex >= questions.length - 1) {
             // Check for new high score BEFORE saving stats
             const isNewHighScore = await checkHighScore(score);

             // Save stats
             await recordQuizResult(
               correctCountRef.current,
               QUESTION_COUNT,
               maxComboRef.current,
               score  // Pass score
             );

             // Navigate to results
             const perfect = isPerfectRound(correctCountRef.current, QUESTION_COUNT);
             router.replace({
               pathname: '/quiz/results',
               params: {
                 score: score.toString(),
                 correctCount: correctCountRef.current.toString(),
                 bestStreak: maxComboRef.current.toString(),
                 isNewHighScore: isNewHighScore ? 'true' : 'false',  // ACTUAL value now
                 isPerfect: perfect ? 'true' : 'false',
               },
             });
           } else {
             setFeedbackText(null);
             dispatch({ type: 'NEXT_QUESTION' });
           }
         }, ANSWER_DELAY);

         return () => clearTimeout(timeout);
       }, [status, currentIndex, questions.length, dispatch, router, score, recordQuizResult, checkHighScore]);
       ```
  </action>
  <verify>TypeScript compiles: `cd medtriad && npx tsc --noEmit`</verify>
  <done>useStats exposes dailyStreak, highScore, checkHighScore. Quiz passes actual isNewHighScore to results.</done>
</task>

<task type="auto">
  <name>Task 3: Display daily streak on home screen</name>
  <files>medtriad/components/home/StatRow.tsx, medtriad/app/(tabs)/index.tsx</files>
  <action>
    Add daily streak display to home screen:

    1. In StatRow.tsx, update ReturningUserStatRow props:
       ```typescript
       type ReturningUserStatRowProps = {
         accuracy: number;
         bestStreak: number;
         totalAnswered: number;
         dailyStreak: number;  // ADD
         highScore: number;    // ADD
         delay?: number;
       };
       ```

    2. Update ReturningUserStatRow to show daily streak instead of best streak:
       The home screen should show daily streak (consecutive days) not best combo streak.
       Replace the "Best" stat with daily streak:

       ```typescript
       export function ReturningUserStatRow({
         accuracy,
         bestStreak,
         totalAnswered,
         dailyStreak,
         highScore,
         delay = 0,
       }: ReturningUserStatRowProps) {
         return (
           <Animated.View
             entering={FadeInUp.delay(delay).duration(Durations.normal).springify()}
             style={styles.statsRow}
           >
             <View style={styles.stat}>
               <IconSymbol name="flame.fill" size={24} color={Colors.light.primary} />
               <Text style={[styles.statValue, { color: Colors.light.text }]}>
                 {dailyStreak}
               </Text>
               <Text style={[styles.statLabel, { color: Colors.light.textMuted }]}>
                 Day Streak
               </Text>
             </View>

             <View style={[styles.divider, { backgroundColor: Colors.light.border }]} />

             <View style={styles.stat}>
               <IconSymbol name="trophy.fill" size={24} color={Colors.light.primary} />
               <Text style={[styles.statValue, { color: Colors.light.text }]}>
                 {highScore.toLocaleString()}
               </Text>
               <Text style={[styles.statLabel, { color: Colors.light.textMuted }]}>
                 High Score
               </Text>
             </View>

             <View style={[styles.divider, { backgroundColor: Colors.light.border }]} />

             <View style={styles.stat}>
               <IconSymbol name="checkmark.circle.fill" size={24} color={Colors.light.primary} />
               <Text style={[styles.statValue, { color: Colors.light.text }]}>
                 {accuracy}%
               </Text>
               <Text style={[styles.statLabel, { color: Colors.light.textMuted }]}>
                 Accuracy
               </Text>
             </View>
           </Animated.View>
         );
       }
       ```

    3. In home screen index.tsx, pass new props:
       ```typescript
       const {
         stats,
         loading,
         isNewUser,
         accuracy,
         masteryLevel,
         dailyStreak,
         highScore,
       } = useStats();

       // In the JSX:
       <ReturningUserStatRow
         accuracy={accuracy}
         bestStreak={stats?.bestStreak ?? 0}
         totalAnswered={stats?.totalAnswered ?? 0}
         dailyStreak={dailyStreak}
         highScore={highScore}
         delay={Durations.stagger * 2}
       />
       ```

    Note: The home screen ReturningUserStatRow now shows:
    - Day Streak (flame icon) - consecutive days
    - High Score (trophy icon) - best score ever
    - Accuracy (checkmark icon) - overall accuracy %
  </action>
  <verify>
    Run the app: `cd medtriad && npx expo start`
    - Home screen shows Day Streak, High Score, Accuracy for returning users
    - Play a quiz, return to home - stats update
    - Close and reopen app - stats persist
    - Play on consecutive days - streak increments (test by clearing storage and playing twice)
  </verify>
  <done>Home screen displays daily streak and high score. Stats persist across app restarts.</done>
</task>

</tasks>

<verification>
- [ ] StoredStats includes highScore, dailyStreak, lastPlayedDate
- [ ] calculateStreak correctly handles: first play, same day, consecutive day, gap
- [ ] checkHighScore returns true when beating record
- [ ] useStats exposes dailyStreak, highScore, checkHighScore
- [ ] Quiz screen calls checkHighScore before navigation
- [ ] Results screen receives actual isNewHighScore value
- [ ] Home screen shows Day Streak with flame icon
- [ ] Home screen shows High Score with trophy icon
- [ ] Stats persist after closing and reopening app
</verification>

<success_criteria>
1. High score persists and displays correctly after app restart
2. Daily streak increments correctly on consecutive days
3. Daily streak resets to 1 after missing a day
4. New High Score badge shows when applicable on results screen
5. Total quizzes (gamesPlayed) persists across sessions
</success_criteria>

<output>
After completion, create `.planning/phases/05-feedback-persistence/05-03-SUMMARY.md`
</output>
