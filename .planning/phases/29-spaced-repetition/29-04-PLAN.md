---
phase: 29-spaced-repetition
plan: 04
type: execute
wave: 3
depends_on: ["29-01", "29-02", "29-03"]
files_modified:
  - medtriad/services/triad-performance-storage.ts
  - medtriad/app/quiz/index.tsx
  - medtriad/app/quiz/study.tsx
autonomous: false

must_haves:
  truths:
    - "First Quiz/Study answer schedules initial review (nextReviewDate = tomorrow)"
    - "SM-2 fields are initialized on first answer (interval=1, repetition=0, efactor=2.5)"
    - "Triads seen in Quiz Mode become eligible for Review Mode the next day"
    - "User can verify Review Mode works end-to-end"
  artifacts:
    - path: "medtriad/services/triad-performance-storage.ts"
      provides: "Updated recordTriadAnswer with SM-2 initialization"
      contains: "nextReviewDate"
  key_links:
    - from: "medtriad/services/triad-performance-storage.ts"
      to: "medtriad/types/triad-performance.ts"
      via: "TriadPerformance with SM-2 fields"
      pattern: "interval.*repetition.*efactor"
---

<objective>
Wire Quiz Mode and Study Mode to initialize SM-2 scheduling on first answer, enabling the review cycle.

Purpose: For triads to appear in Review Mode, they must first be seen in Quiz or Study Mode and have nextReviewDate set. This plan completes the data flow so users can start building their review queue.

Output: Playing Quiz or Study Mode populates SM-2 fields, making those triads eligible for review starting the next day.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-spaced-repetition/29-RESEARCH.md
@.planning/phases/29-spaced-repetition/29-01-SUMMARY.md
@.planning/phases/29-spaced-repetition/29-02-SUMMARY.md
@.planning/phases/29-spaced-repetition/29-03-SUMMARY.md

# Files to modify
@medtriad/services/triad-performance-storage.ts
@medtriad/app/quiz/index.tsx
@medtriad/app/quiz/study.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update recordTriadAnswer to initialize SM-2 fields</name>
  <files>medtriad/services/triad-performance-storage.ts</files>
  <action>
Modify `recordTriadAnswer` to initialize SM-2 scheduling fields when recording an answer.

**Current behavior:** Records correctCount, incorrectCount, lastSeenAt, avgResponseTimeMs, responseCount

**New behavior:** Also initializes/updates SM-2 fields (interval, repetition, efactor, nextReviewDate)

**Logic:**
1. When creating a new performance entry (first time seeing this triad):
   - Set `interval: 1` (will review in 1 day)
   - Set `repetition: 0` (no successful review recalls yet)
   - Set `efactor: 2.5` (default ease factor)
   - Set `nextReviewDate` to tomorrow (new Date() + 1 day, ISO string)

2. When updating an existing entry:
   - If `nextReviewDate` is null (old data without SM-2 fields):
     - Initialize same as new entry
   - If `nextReviewDate` already exists:
     - Keep existing SM-2 fields unchanged (Quiz/Study Mode doesn't run SM-2 algorithm)
     - SM-2 progression only happens in Review Mode via recordReviewAnswer

**Why this approach:**
- Quiz Mode is for initial exposure and practice
- Review Mode is for spaced repetition scheduling
- First Quiz answer sets nextReviewDate to "tomorrow" to bootstrap the review cycle
- Subsequent Quiz/Study answers don't change the schedule (that's Review Mode's job)

**Code change in recordTriadAnswer:**
```typescript
// After calculating correctCount, incorrectCount, avgResponseTimeMs...

// Initialize SM-2 fields for new entries or entries without scheduling
const needsScheduleInit = !existing || existing.nextReviewDate === undefined || existing.nextReviewDate === null;

// Calculate tomorrow for initial review
const tomorrow = new Date();
tomorrow.setDate(tomorrow.getDate() + 1);
const tomorrowISO = tomorrow.toISOString();

const updated: TriadPerformance = {
  correctCount,
  incorrectCount,
  lastSeenAt: new Date().toISOString(),
  avgResponseTimeMs: newAvg,
  responseCount: oldCount + 1,
  // SM-2 fields: initialize if needed, otherwise preserve
  interval: needsScheduleInit ? 1 : (existing?.interval ?? 1),
  repetition: needsScheduleInit ? 0 : (existing?.repetition ?? 0),
  efactor: needsScheduleInit ? 2.5 : (existing?.efactor ?? 2.5),
  nextReviewDate: needsScheduleInit ? tomorrowISO : (existing?.nextReviewDate ?? tomorrowISO),
};
```

This ensures backward compatibility: existing data without SM-2 fields gets initialized on next answer.
  </action>
  <verify>TypeScript compiles: `cd medtriad && npx tsc --noEmit`</verify>
  <done>recordTriadAnswer initializes SM-2 fields (interval, repetition, efactor, nextReviewDate) on first answer or for legacy data.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete spaced repetition system: SM-2 algorithm, Review Mode UI, home screen integration, and Quiz/Study Mode data initialization</what-built>
  <how-to-verify>
**End-to-end verification:**

1. **Clear app data** (or use fresh simulator) to start with no triads seen

2. **Play Quiz Mode:**
   - Start a quiz and answer a few questions
   - Note which triads you answered

3. **Check Review Mode (should be empty):**
   - Go to home screen
   - Review badge should NOT appear (triads aren't due until tomorrow)
   - Tap Study or look for Review button - should be disabled or show 0 due

4. **Simulate "tomorrow" (optional - for full verification):**
   - In developer tools, advance the date by 1 day
   - OR manually edit AsyncStorage to set nextReviewDate to yesterday
   - OR wait until tomorrow to test

5. **Verify Review Mode works:**
   - After date advance, home screen should show "X triads due" badge
   - Tap to enter Review Mode
   - Answer questions (untimed, with explanations)
   - Complete review and see results screen

6. **Verify SM-2 progression:**
   - Answer a triad correctly multiple times
   - Its interval should increase (won't be due as soon)
   - Answer incorrectly - should reset to short interval

**Visual checks:**
- Review Mode has no timer (SR-03)
- "All caught up" state appears when no triads are due
- Results screen shows review stats
- Tricky button works in Review Mode
  </how-to-verify>
  <resume-signal>Type "approved" if the spaced repetition flow works end-to-end, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd medtriad && npx tsc --noEmit`
2. Quiz Mode answer sets nextReviewDate to tomorrow
3. Review Mode shows triads with past due dates
4. SM-2 algorithm correctly updates intervals after review answers
5. Home screen badge reflects accurate due count
</verification>

<success_criteria>
- First Quiz/Study answer bootstraps SM-2 with nextReviewDate = tomorrow
- Existing data without SM-2 fields gets initialized on next answer
- Complete review flow verified: Quiz -> wait -> Review -> results
- User confirms system works as expected
</success_criteria>

<output>
After completion, create `.planning/phases/29-spaced-repetition/29-04-SUMMARY.md`
</output>
