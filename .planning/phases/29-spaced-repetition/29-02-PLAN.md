---
phase: 29-spaced-repetition
plan: 02
type: execute
wave: 2
depends_on: ["29-01"]
files_modified:
  - medtriad/types/review-state.ts
  - medtriad/hooks/use-review-reducer.ts
  - medtriad/app/quiz/review.tsx
  - medtriad/app/quiz/review-results.tsx
autonomous: true

must_haves:
  truths:
    - "User can practice only due triads in Review Mode (SR-02)"
    - "Review Mode has no countdown timer - untimed (SR-03)"
    - "Answering a question updates SM-2 scheduling via recordReviewAnswer (SR-04)"
    - "User sees 'all caught up' message when no triads are due"
    - "User can mark questions as tricky during review"
  artifacts:
    - path: "medtriad/types/review-state.ts"
      provides: "Review mode state types (clone of study-state)"
      exports: ["ReviewState", "ReviewAction", "ReviewStatus"]
    - path: "medtriad/hooks/use-review-reducer.ts"
      provides: "Review mode reducer (clone of study reducer)"
      exports: ["useReviewReducer"]
    - path: "medtriad/app/quiz/review.tsx"
      provides: "Review Mode screen with due-triad filtering"
      min_lines: 150
    - path: "medtriad/app/quiz/review-results.tsx"
      provides: "Review results screen"
      min_lines: 80
  key_links:
    - from: "medtriad/app/quiz/review.tsx"
      to: "medtriad/services/spaced-repetition.ts"
      via: "getDueTriads, recordReviewAnswer"
      pattern: "getDueTriads|recordReviewAnswer"
    - from: "medtriad/app/quiz/review.tsx"
      to: "medtriad/hooks/use-review-reducer.ts"
      via: "useReviewReducer hook"
      pattern: "useReviewReducer"
---

<objective>
Create Review Mode UI that allows users to practice triads due for review.

Purpose: Review Mode is how users interact with the spaced repetition system. It mirrors Study Mode's untimed, relaxed experience but sources questions from due triads only.

Output: Complete Review Mode flow with review.tsx screen, review-results.tsx screen, and supporting state management - all following established Study Mode patterns.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-spaced-repetition/29-RESEARCH.md
@.planning/phases/29-spaced-repetition/29-01-SUMMARY.md

# Patterns to clone from Study Mode
@medtriad/types/study-state.ts
@medtriad/hooks/use-study-reducer.ts
@medtriad/app/quiz/study.tsx
@medtriad/app/quiz/study-results.tsx

# Services to use
@medtriad/services/spaced-repetition.ts
@medtriad/services/question-generator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create review-state types and use-review-reducer hook</name>
  <files>medtriad/types/review-state.ts, medtriad/hooks/use-review-reducer.ts</files>
  <action>
**Create medtriad/types/review-state.ts** by cloning study-state.ts with these changes:

1. Rename types: `StudyStatus` -> `ReviewStatus`, `StudyState` -> `ReviewState`, `StudyAction` -> `ReviewAction`
2. Add an `allCaughtUp` boolean field to ReviewState (for when no triads are due)
3. Add a `NO_REVIEWS_DUE` action type to ReviewAction union
4. Keep all other fields identical (status, questions, currentIndex, correctCount, selectedOptionId, showExplanation, trickyQuestionIds)
5. Rename constant: `STUDY_QUESTION_COUNT` -> remove (Review Mode uses variable count based on due triads)

**Create medtriad/hooks/use-review-reducer.ts** by cloning use-study-reducer.ts with these changes:

1. Import from `@/types/review-state` instead of study-state
2. Rename reducer function: `studyReducer` -> `reviewReducer`
3. Rename hook: `useStudyReducer` -> `useReviewReducer`
4. Add `allCaughtUp: false` to initial state
5. Add handler for `NO_REVIEWS_DUE` action: sets `status: 'completed'` and `allCaughtUp: true`
6. Rename action type constants: `START_STUDY` -> `START_REVIEW`
7. Keep all other logic identical (SELECT_ANSWER, TOGGLE_TRICKY, NEXT_QUESTION, RESET)

The reducer state machine should be:
- idle -> playing (START_REVIEW) OR completed (NO_REVIEWS_DUE)
- playing -> answered (SELECT_ANSWER)
- answered -> playing (NEXT_QUESTION if more)
- answered -> completed (NEXT_QUESTION if none)
  </action>
  <verify>TypeScript compiles: `cd medtriad && npx tsc --noEmit`</verify>
  <done>review-state.ts exports ReviewState, ReviewAction, ReviewStatus. use-review-reducer.ts exports useReviewReducer hook with NO_REVIEWS_DUE handling.</done>
</task>

<task type="auto">
  <name>Task 2: Create Review Mode screen</name>
  <files>medtriad/app/quiz/review.tsx</files>
  <action>
Create review.tsx by adapting study.tsx with these key differences:

**Imports:**
- Import `useReviewReducer` from `@/hooks/use-review-reducer`
- Import `getDueTriads, recordReviewAnswer` from `@/services/spaced-repetition`
- Import `generateQuestion` from `@/services/question-generator` (NOT generateQuestionSet)

**Initialization (useEffect on mount):**
```typescript
useEffect(() => {
  async function loadDueTriads() {
    const dueTriads = await getDueTriads();

    if (dueTriads.length === 0) {
      dispatch({ type: 'NO_REVIEWS_DUE' });
      return;
    }

    // Generate questions from due triads only
    const questions = dueTriads.map(triad => generateQuestion(triad));
    dispatch({ type: 'START_REVIEW', questions });
  }

  loadDueTriads();
}, [dispatch]);
```

**Answer handling:**
- Call `recordReviewAnswer(currentQuestion.triad.id, option.isCorrect)` instead of `recordTriadAnswer`
- This updates SM-2 scheduling fields

**Header:**
- Use StudyHeader component (same calm blue styling)
- Or create a simple header showing "Review - {currentIndex + 1} of {questions.length}"

**"All caught up" state:**
When `state.allCaughtUp` is true, render a friendly completion screen:
```tsx
if (state.allCaughtUp) {
  return (
    <SafeAreaView style={styles.container}>
      <View style={styles.caughtUpContainer}>
        <Text variant="title" color="primary" align="center">
          All Caught Up!
        </Text>
        <Text variant="body" color="secondary" align="center">
          No triads are due for review right now. Keep practicing in Quiz or Study mode!
        </Text>
        <Button
          label="Back to Home"
          variant="primary"
          onPress={() => router.replace('/(tabs)')}
        />
      </View>
    </SafeAreaView>
  );
}
```

**Everything else:** Clone from study.tsx - same FindingsCard, AnswerCard, ExplanationCard, TrickyButton, Continue button, scroll behavior, and styling.

Remove: Category filtering (Review Mode reviews ALL due triads regardless of category).
  </action>
  <verify>App builds: `cd medtriad && npx expo export --platform ios` (or just TypeScript check)</verify>
  <done>review.tsx renders Review Mode with due-triad filtering, recordReviewAnswer on answer, and "all caught up" empty state.</done>
</task>

<task type="auto">
  <name>Task 3: Create Review Results screen</name>
  <files>medtriad/app/quiz/review-results.tsx</files>
  <action>
Create review-results.tsx by adapting study-results.tsx with these changes:

**Route params:**
```typescript
type ReviewResultsParams = {
  correctCount: string;
  totalQuestions: string;
  trickyCount: string;
};
```

**Hero text:**
- Title: "Review Complete" (instead of "Session Complete")
- Subtitle: "questions reviewed" (instead of "questions answered correctly")

**Encouraging message:**
- "Great review session! Your scheduled intervals have been updated."

**Action buttons:**
1. "Review More" -> navigates to `/quiz/review` (only if there might be more due)
2. "Back to Home" -> navigates to `/(tabs)`

**Styling:** Clone study-results.tsx styling exactly (calm blue theme, centered layout, tricky badge if trickyCount > 0).

**Important:** Review Mode results should feel calm and encouraging, not competitive. No scores, no tier progression, just learning reinforcement.
  </action>
  <verify>TypeScript compiles: `cd medtriad && npx tsc --noEmit`</verify>
  <done>review-results.tsx displays review completion with correct/total count, tricky count, and navigation buttons.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd medtriad && npx tsc --noEmit`
2. Review Mode screen renders without errors
3. "All caught up" state displays when no triads are due
4. Answering a question calls recordReviewAnswer
5. Continue navigates to review-results after last question
</verification>

<success_criteria>
- Review Mode loads only due triads from getDueTriads() (SR-02)
- No timer visible in Review Mode (SR-03)
- Each answer calls recordReviewAnswer to update SM-2 state (SR-04)
- Empty state shows "All Caught Up!" with navigation to home
- Tricky button works to mark questions
- Results screen shows completion stats
</success_criteria>

<output>
After completion, create `.planning/phases/29-spaced-repetition/29-02-SUMMARY.md`
</output>
