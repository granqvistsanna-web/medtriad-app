---
phase: 29-spaced-repetition
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - medtriad/types/triad-performance.ts
  - medtriad/services/spaced-repetition.ts
  - medtriad/__tests__/spaced-repetition.test.ts
autonomous: true

must_haves:
  truths:
    - "SM-2 algorithm calculates correct intervals for consecutive correct answers (1, 6, then EF-scaled)"
    - "SM-2 algorithm resets to interval=1 on incorrect answer"
    - "Intervals are capped at 14 days maximum (SR-05)"
    - "Tricky-marked triads get 0.5x interval multiplier (SR-06)"
    - "Ease factor never goes below 1.3"
  artifacts:
    - path: "medtriad/types/triad-performance.ts"
      provides: "SM-2 scheduling fields (interval, repetition, efactor, nextReviewDate)"
      contains: "nextReviewDate"
    - path: "medtriad/services/spaced-repetition.ts"
      provides: "SM-2 algorithm, due triads query, review answer recording"
      exports: ["calculateSM2", "getDueTriads", "getDueTriadCount", "recordReviewAnswer"]
    - path: "medtriad/__tests__/spaced-repetition.test.ts"
      provides: "Test coverage for SM-2 algorithm edge cases"
      min_lines: 80
  key_links:
    - from: "medtriad/services/spaced-repetition.ts"
      to: "medtriad/services/triad-performance-storage.ts"
      via: "loadTriadPerformance, saveTriadPerformance"
      pattern: "loadTriadPerformance|saveTriadPerformance"
    - from: "medtriad/services/spaced-repetition.ts"
      to: "medtriad/services/study-storage.ts"
      via: "loadTrickyQuestions for tricky multiplier"
      pattern: "loadTrickyQuestions"
---

<objective>
Implement the SM-2 spaced repetition algorithm and scheduling service.

Purpose: SM-2 is the foundation for intelligent review scheduling. It determines when each triad should next be reviewed based on user performance, creating optimal spacing for long-term retention.

Output: A tested spaced-repetition service that can calculate next review dates, query due triads, and record review answers with proper SM-2 state updates.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-spaced-repetition/29-RESEARCH.md

# Existing patterns to follow
@medtriad/types/triad-performance.ts
@medtriad/services/triad-performance-storage.ts
@medtriad/services/study-storage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend TriadPerformance type with SM-2 fields</name>
  <files>medtriad/types/triad-performance.ts</files>
  <action>
Add SM-2 scheduling fields to the existing TriadPerformance interface:

```typescript
/** Days between reviews (SM-2 interval) */
interval: number;

/** Count of consecutive correct reviews (SM-2 repetition) */
repetition: number;

/** Ease factor for interval calculation (min 1.3, default 2.5) */
efactor: number;

/** ISO date string of next scheduled review date, null if never reviewed */
nextReviewDate: string | null;
```

These fields are ADDED to the existing interface, not replacing any fields. The existing fields (correctCount, incorrectCount, lastSeenAt, avgResponseTimeMs, responseCount) remain unchanged.

Add JSDoc comments explaining each SM-2 field's purpose.
  </action>
  <verify>TypeScript compiles: `cd medtriad && npx tsc --noEmit`</verify>
  <done>TriadPerformance interface includes interval, repetition, efactor, and nextReviewDate fields with JSDoc comments.</done>
</task>

<task type="auto">
  <name>Task 2: Create spaced-repetition service with SM-2 algorithm</name>
  <files>medtriad/services/spaced-repetition.ts</files>
  <action>
Create a new service file implementing the SM-2 algorithm and related functions.

**Constants (at top of file):**
```typescript
const MAX_REVIEW_INTERVAL_DAYS = 14;      // SR-05
const TRICKY_INTERVAL_MULTIPLIER = 0.5;   // SR-06
const MIN_EASE_FACTOR = 1.3;              // SM-2 minimum
const DEFAULT_EASE_FACTOR = 2.5;          // SM-2 default
```

**Export these functions:**

1. `calculateSM2(interval: number, repetition: number, efactor: number, isCorrect: boolean, isTricky: boolean): SM2Result`
   - Binary quality mapping: correct = 4, incorrect = 1
   - EF formula: `EF' = EF + (0.1 - (5-q) * (0.08 + (5-q) * 0.02))`
   - Clamp efactor to minimum 1.3
   - If quality >= 3 (correct): advance interval (rep0=1, rep1=6, else interval*EF)
   - If quality < 3 (incorrect): reset repetition=0, interval=1
   - Apply 14-day cap (SR-05)
   - Apply 0.5x tricky multiplier if isTricky and interval > 1 (SR-06)
   - Calculate nextReviewDate from today + interval days

2. `getDueTriads(): Promise<Triad[]>`
   - Load performance record and all triads
   - Filter to triads where: performance exists AND nextReviewDate is not null AND nextReviewDate <= now
   - Never-seen triads are NOT due (they need Quiz Mode first)

3. `getDueTriadCount(): Promise<number>`
   - Simple wrapper that returns getDueTriads().length

4. `recordReviewAnswer(triadId: string, isCorrect: boolean): Promise<void>`
   - Load performance record and tricky questions
   - Get existing performance or create defaults (interval=0, repetition=0, efactor=2.5, nextReviewDate=null)
   - Calculate new SM-2 values using calculateSM2
   - Update correctCount/incorrectCount and lastSeenAt
   - Keep avgResponseTimeMs unchanged (Review Mode is untimed)
   - Save updated record (fire-and-forget pattern with try/catch)

**Type definition (internal to file):**
```typescript
interface SM2Result {
  interval: number;
  repetition: number;
  efactor: number;
  nextReviewDate: string;
}
```

Reference: https://super-memory.com/english/ol/sm2.htm for algorithm details.
  </action>
  <verify>`cd medtriad && npx tsc --noEmit` compiles without errors</verify>
  <done>spaced-repetition.ts exports calculateSM2, getDueTriads, getDueTriadCount, and recordReviewAnswer functions.</done>
</task>

<task type="auto">
  <name>Task 3: Write comprehensive tests for SM-2 algorithm</name>
  <files>medtriad/__tests__/spaced-repetition.test.ts</files>
  <action>
Create test file for the SM-2 algorithm. Focus on the pure calculateSM2 function which has no side effects.

**Test cases to cover:**

1. **First correct answer:** interval=0, repetition=0 -> interval=1, repetition=1
2. **Second correct answer:** interval=1, repetition=1 -> interval=6, repetition=2
3. **Third correct answer:** Uses EF multiplication (interval=6, EF=2.5 -> interval~15, but capped to 14)
4. **Incorrect answer resets:** Any state -> interval=1, repetition=0
5. **14-day cap (SR-05):** Large intervals get capped to 14
6. **Tricky multiplier (SR-06):** interval=6, isTricky=true -> interval=3
7. **Tricky multiplier minimum:** interval=1 stays at 1 even with tricky
8. **EF never below 1.3:** After many incorrect answers, EF stays at 1.3
9. **EF adjustment for correct:** quality=4 -> EF unchanged (neutral adjustment)
10. **EF adjustment for incorrect:** quality=1 -> EF decreases

**Test structure:**
```typescript
import { calculateSM2 } from '@/services/spaced-repetition';

describe('SM-2 Algorithm', () => {
  describe('calculateSM2', () => {
    // ... test cases
  });
});
```

Use Jest's `expect` matchers. Mock Date if needed for nextReviewDate assertions (or just verify it's a valid ISO string in the future).
  </action>
  <verify>`cd medtriad && npm test -- spaced-repetition.test.ts` passes all tests</verify>
  <done>At least 10 test cases pass covering all SM-2 edge cases including 14-day cap and tricky multiplier.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `cd medtriad && npx tsc --noEmit`
2. All SM-2 tests pass: `cd medtriad && npm test -- spaced-repetition.test.ts`
3. Service exports are accessible: Verify imports work in a test file
</verification>

<success_criteria>
- TriadPerformance type extended with interval, repetition, efactor, nextReviewDate
- calculateSM2 implements correct SM-2 formula with binary quality mapping
- 14-day interval cap enforced (SR-05)
- Tricky items get 0.5x interval (SR-06)
- getDueTriads returns only seen triads with past due dates
- recordReviewAnswer updates all SM-2 fields correctly
- 10+ test cases pass covering algorithm edge cases
</success_criteria>

<output>
After completion, create `.planning/phases/29-spaced-repetition/29-01-SUMMARY.md`
</output>
