---
phase: 23-study-mode
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - medtriad/types/study-state.ts
  - medtriad/hooks/use-study-reducer.ts
  - medtriad/services/study-storage.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Study reducer can start a session without timer logic"
    - "Study reducer can track answered state with explanation visibility"
    - "Study reducer can toggle tricky flag for current question"
    - "Tricky questions persist to AsyncStorage"
  artifacts:
    - path: "medtriad/types/study-state.ts"
      provides: "Study mode type definitions"
      exports: ["StudyStatus", "StudyState", "StudyAction", "StudySessionResult"]
    - path: "medtriad/hooks/use-study-reducer.ts"
      provides: "Study mode state management"
      exports: ["useStudyReducer"]
    - path: "medtriad/services/study-storage.ts"
      provides: "Tricky questions persistence"
      exports: ["loadTrickyQuestions", "toggleTrickyQuestion", "saveTrickyQuestion", "removeTrickyQuestion", "TrickyQuestion"]
  key_links:
    - from: "medtriad/hooks/use-study-reducer.ts"
      to: "medtriad/types/study-state.ts"
      via: "imports StudyState, StudyAction"
      pattern: "import.*from.*study-state"
    - from: "medtriad/services/study-storage.ts"
      to: "@react-native-async-storage/async-storage"
      via: "AsyncStorage API"
      pattern: "AsyncStorage\\.(getItem|setItem)"
---

<objective>
Create the foundation layer for Study Mode: types, state reducer, and persistence service.

Purpose: Establish the state management and data persistence patterns that the Study Mode screen will build upon. This follows the existing quiz architecture pattern (types -> reducer -> storage) but removes timer logic and adds explanation/tricky tracking.

Output: Three files providing type definitions, reducer hook, and AsyncStorage service for Study Mode.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-study-mode/23-RESEARCH.md

Reference existing patterns:
@medtriad/types/quiz-state.ts
@medtriad/hooks/use-quiz-reducer.ts
@medtriad/services/stats-storage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Study Mode Types</name>
  <files>medtriad/types/study-state.ts</files>
  <action>
Create study mode type definitions following the pattern in quiz-state.ts but WITHOUT timer-related fields.

Define:
1. `StudyStatus`: 'idle' | 'playing' | 'answered' | 'completed' (same as quiz but semantically different - no time pressure)

2. `StudyState` interface with:
   - status: StudyStatus
   - questions: QuizQuestion[] (reuse existing type)
   - currentIndex: number
   - correctCount: number (simple counter, no score points)
   - selectedOptionId: string | null
   - showExplanation: boolean (new - controls explanation card visibility)
   - trickyQuestionIds: string[] (in-session tracking of marked questions)

3. `StudyAction` union type:
   - START_STUDY: { type: 'START_STUDY'; questions: QuizQuestion[] }
   - SELECT_ANSWER: { type: 'SELECT_ANSWER'; optionId: string; isCorrect: boolean }
   - TOGGLE_TRICKY: { type: 'TOGGLE_TRICKY'; triadId: string }
   - NEXT_QUESTION: { type: 'NEXT_QUESTION' }
   - RESET: { type: 'RESET' }

4. `StudySessionResult` interface for summary:
   - completedAt: string (ISO date)
   - correctCount: number
   - totalQuestions: number
   - trickyQuestionIds: string[]

Export STUDY_QUESTION_COUNT = 10 (same as timed mode for consistency).

Import QuizQuestion from './question'.
  </action>
  <verify>
    - File exists at medtriad/types/study-state.ts
    - TypeScript compiles: `cd medtriad && npx tsc --noEmit`
    - Exports are accessible: grep for 'StudyState', 'StudyAction', 'StudyStatus'
  </verify>
  <done>Study mode types defined with no timer-related fields, explanation and tricky tracking fields present</done>
</task>

<task type="auto">
  <name>Task 2: Create Study Reducer Hook</name>
  <files>medtriad/hooks/use-study-reducer.ts</files>
  <action>
Create the study mode reducer following use-quiz-reducer.ts pattern but WITHOUT any timer logic.

1. Define initialState: StudyState with:
   - status: 'idle'
   - questions: []
   - currentIndex: 0
   - correctCount: 0
   - selectedOptionId: null
   - showExplanation: false
   - trickyQuestionIds: []

2. Create studyReducer function handling:

   START_STUDY:
   - Set status to 'playing'
   - Store questions
   - Reset all counters

   SELECT_ANSWER:
   - Only allow when status === 'playing'
   - Set status to 'answered'
   - Set selectedOptionId
   - Set showExplanation to true (key difference from timed quiz)
   - Increment correctCount if isCorrect

   TOGGLE_TRICKY:
   - Toggle triadId in trickyQuestionIds array
   - If present, remove it; if absent, add it

   NEXT_QUESTION:
   - If more questions: increment currentIndex, set status to 'playing', clear selectedOptionId, set showExplanation to false
   - If no more questions: set status to 'completed'

   RESET:
   - Return initialState

3. Export useStudyReducer hook that returns useReducer(studyReducer, initialState)

NO timer logic, NO scoring, NO combo tracking. Simple correct/incorrect counting only.
  </action>
  <verify>
    - File exists at medtriad/hooks/use-study-reducer.ts
    - TypeScript compiles: `cd medtriad && npx tsc --noEmit`
    - No references to 'timer', 'tick', 'time', 'score', 'combo' in the file
  </verify>
  <done>Study reducer manages state without timer, with explanation visibility and tricky tracking</done>
</task>

<task type="auto">
  <name>Task 3: Create Study Storage Service</name>
  <files>medtriad/services/study-storage.ts</files>
  <action>
Create AsyncStorage service for tricky questions persistence, following stats-storage.ts patterns.

1. Define constants:
   - TRICKY_KEY = '@medtriad_tricky_questions'
   - STUDY_HISTORY_KEY = '@medtriad_study_history'
   - MAX_STUDY_HISTORY = 20

2. Define TrickyQuestion interface:
   - triadId: string
   - markedAt: string (ISO date)
   - category: TriadCategory (import from types/triad)

3. Define StudyHistoryEntry interface:
   - completedAt: string (ISO date)
   - correctCount: number
   - totalQuestions: number
   - trickyCount: number (how many marked as tricky)

4. Implement functions:

   loadTrickyQuestions(): Promise<TrickyQuestion[]>
   - Get from AsyncStorage, parse JSON, return empty array on error

   saveTrickyQuestion(triadId: string, category: TriadCategory): Promise<void>
   - Load current, check if exists (skip if so), add new entry with timestamp, save

   removeTrickyQuestion(triadId: string): Promise<void>
   - Load current, filter out matching triadId, save

   toggleTrickyQuestion(triadId: string, category: TriadCategory): Promise<boolean>
   - Returns true if added, false if removed
   - Load current, check existence, add or remove accordingly

   loadStudyHistory(): Promise<StudyHistoryEntry[]>
   - Get from AsyncStorage, parse, return empty array on error

   saveStudySession(entry: StudyHistoryEntry): Promise<void>
   - Prepend to history, limit to MAX_STUDY_HISTORY, save

Use try/catch with console.error for all AsyncStorage operations (same pattern as stats-storage.ts).
  </action>
  <verify>
    - File exists at medtriad/services/study-storage.ts
    - TypeScript compiles: `cd medtriad && npx tsc --noEmit`
    - All 6 functions exported
    - AsyncStorage import present
  </verify>
  <done>Study storage service persists tricky questions and study session history</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. TypeScript compiles without errors: `cd medtriad && npx tsc --noEmit`
2. All three files exist in correct locations
3. Types are properly connected (reducer imports types, storage uses TriadCategory)
4. No timer-related code in any of the new files
</verification>

<success_criteria>
- StudyState type has showExplanation and trickyQuestionIds fields
- Study reducer handles all 5 action types without timer logic
- Study storage can persist and retrieve tricky questions
- All exports are typed and accessible
</success_criteria>

<output>
After completion, create `.planning/phases/23-study-mode/23-01-SUMMARY.md`
</output>
