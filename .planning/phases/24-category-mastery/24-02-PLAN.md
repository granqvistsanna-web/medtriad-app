---
phase: 24-category-mastery
plan: 02
type: execute
wave: 2
depends_on: ["24-01"]
files_modified:
  - medtriad/app/quiz/index.tsx
  - medtriad/app/(tabs)/index.tsx
autonomous: true

must_haves:
  truths:
    - "Each quiz answer updates the corresponding category's correct/total count"
    - "Home screen displays category mastery cards showing progress for each category"
    - "Each category card shows a visual progress indicator (percentage)"
  artifacts:
    - path: "medtriad/app/quiz/index.tsx"
      provides: "Category tracking during quiz with categoryResultsRef"
      contains: "categoryResultsRef"
    - path: "medtriad/app/(tabs)/index.tsx"
      provides: "Real categoryMastery data passed to CategoryMastery component"
      contains: "getCategoryPercent"
  key_links:
    - from: "medtriad/app/quiz/index.tsx"
      to: "medtriad/hooks/useStats.ts"
      via: "recordQuizResult with categoryResults"
      pattern: "categoryResultsRef\\.current"
    - from: "medtriad/app/(tabs)/index.tsx"
      to: "medtriad/components/home/CategoryMastery.tsx"
      via: "categoryMastery prop with real percentages"
      pattern: "getCategoryPercent"
---

<objective>
Wire category tracking into the quiz flow and connect real data to the Home screen CategoryMastery component.

Purpose: Requirements CM-03 (display cards) and CM-04 (visual progress) need the quiz to track category results and the Home screen to display them.

Output: Quiz tracks category results per answer and saves at completion; Home screen shows real category mastery percentages.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-category-mastery/24-RESEARCH.md
@.planning/phases/24-category-mastery/24-01-SUMMARY.md

@medtriad/app/quiz/index.tsx
@medtriad/app/(tabs)/index.tsx
@medtriad/components/home/CategoryMastery.tsx
@medtriad/types/triad.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Track category results in quiz screen</name>
  <files>medtriad/app/quiz/index.tsx</files>
  <action>
1. Import CategoryMasteryData from stats-storage:
```typescript
import { CategoryMasteryData } from '@/services/stats-storage';
```

2. Import TriadCategory from types (add to existing QuizOption import line or separate):
```typescript
import { TriadCategory } from '@/types/triad';
```

3. Add categoryResultsRef after maxComboRef (around line 43):
```typescript
const categoryResultsRef = useRef<Record<TriadCategory, CategoryMasteryData>>({} as Record<TriadCategory, CategoryMasteryData>);
```

4. In handleAnswerSelect function, after the existing correct tracking logic (around line 177, after `correctCountRef.current += 1`), add category tracking:
```typescript
// Track category result for mastery
const category = currentQuestion.triad.category;
const current = categoryResultsRef.current[category] ?? { correct: 0, total: 0 };
categoryResultsRef.current[category] = {
  correct: current.correct + (option.isCorrect ? 1 : 0),
  total: current.total + 1,
};
```

Note: This goes INSIDE the `if (option.isCorrect)` block after incrementing correctCountRef, but we also need to track incorrect answers. Move category tracking OUTSIDE the if/else block, but before the else clause:

Actually, to track both correct and incorrect answers:
```typescript
// After dispatch and before if(option.isCorrect)
// Track category result for mastery
const category = currentQuestion.triad.category;
const current = categoryResultsRef.current[category] ?? { correct: 0, total: 0 };
categoryResultsRef.current[category] = {
  correct: current.correct + (option.isCorrect ? 1 : 0),
  total: current.total + 1,
};

if (option.isCorrect) {
  // existing correct answer logic...
```

5. Update recordQuizResult call (around line 100-105) to pass categoryResults:
```typescript
await recordQuizResult(
  correctCountRef.current,
  QUESTION_COUNT,
  maxComboRef.current,
  score,
  categoryResultsRef.current  // NEW: Pass category results
);
```

6. Also update the error fallback recordQuizResult call (if present in the catch block) - but checking the code, the error path navigates directly without saving, which is intentional per ERR-04 design decision. No change needed there.
  </action>
  <verify>TypeScript compiles: `cd /Users/sannagranqvist/Documents/App/medtriad-app/medtriad && npx tsc --noEmit`</verify>
  <done>Quiz tracks correct/incorrect per category and saves with quiz results</done>
</task>

<task type="auto">
  <name>Task 2: Connect Home screen to real category mastery data</name>
  <files>medtriad/app/(tabs)/index.tsx</files>
  <action>
1. Import TriadCategory from types (add at top with other imports):
```typescript
import { TriadCategory } from '@/types/triad';
```

2. Add getCategoryPercent to the useStats destructuring (around line 29):
```typescript
const {
  stats,
  loading,
  isNewUser,
  accuracy,
  dailyStreak,
  highScore,
  tier,
  tierProgress,
  nextTier,
  totalPoints,
  pointsToNextTier,
  pendingTierUp,
  clearPendingTierUp,
  getCategoryPercent,  // NEW
} = useStats();
```

3. Update CategoryMastery component props (around line 103-107) to pass real data:
```typescript
<CategoryMastery
  categoryMastery={{
    cardiology: getCategoryPercent('cardiology'),
    neurology: getCategoryPercent('neurology'),
    pulmonary: getCategoryPercent('pulmonary'),
    endocrine: getCategoryPercent('endocrine'),
  }}
  onCategoryPress={(category) => router.push('/(tabs)/progress')}
  delay={Durations.stagger * 3}
/>
```

Note: CategoryMastery component currently hardcodes these 4 categories in display order. We pass real percentages for these 4 specifically (matching the component's internal categories array).
  </action>
  <verify>
1. TypeScript compiles: `cd /Users/sannagranqvist/Documents/App/medtriad-app/medtriad && npx tsc --noEmit`
2. Start app: `cd /Users/sannagranqvist/Documents/App/medtriad-app/medtriad && npx expo start` - verify Home screen loads without errors
  </verify>
  <done>Home screen CategoryMastery component shows real percentage data from user stats</done>
</task>

<task type="auto">
  <name>Task 3: Verify end-to-end category tracking</name>
  <files>None (verification only)</files>
  <action>
Verify the complete flow works by:

1. Run the app: `cd /Users/sannagranqvist/Documents/App/medtriad-app/medtriad && npx expo start`

2. Clear stats if needed (via dev tools in Settings if available, or reset AsyncStorage)

3. Play a quiz - answer some questions from different categories

4. After quiz completion, return to Home screen

5. Verify CategoryMastery cards now show non-zero percentages for categories that were answered

6. Close and reopen app - verify percentages persist

7. Play another quiz - verify percentages update correctly (accumulate, not replace)

If any step fails, debug and fix before completing.
  </action>
  <verify>
1. Home screen shows 0% for all categories initially (new user)
2. After completing a quiz, relevant categories show updated percentages
3. Percentages persist after app restart
4. Playing multiple quizzes accumulates category data correctly
  </verify>
  <done>Category mastery tracking works end-to-end: quiz tracks -> storage persists -> Home displays</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Quiz screen tracks category results per answer
3. Category results saved to storage when quiz completes
4. Home screen displays real category percentages
5. Percentages persist across app restarts
6. Multiple quiz sessions accumulate data correctly
</verification>

<success_criteria>
- Each quiz answer updates the corresponding category's correct/total count (CM-01)
- Category mastery data persists across app restarts (CM-02)
- Home screen displays category mastery cards showing progress for each category (CM-03)
- Each category card shows a visual progress indicator (percentage) (CM-04)
</success_criteria>

<output>
After completion, create `.planning/phases/24-category-mastery/24-02-SUMMARY.md`
</output>
