---
phase: 24-category-mastery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - medtriad/services/stats-storage.ts
  - medtriad/hooks/useStats.ts
autonomous: true

must_haves:
  truths:
    - "Category mastery data persists across app restarts"
    - "Existing users with stats get default zero values for all categories"
    - "Quiz results can update category-specific correct/total counts"
  artifacts:
    - path: "medtriad/services/stats-storage.ts"
      provides: "CategoryMasteryData type and categoryMastery field in StoredStats"
      contains: "categoryMastery"
    - path: "medtriad/hooks/useStats.ts"
      provides: "categoryMastery and getCategoryPercent in return value"
      contains: "getCategoryPercent"
  key_links:
    - from: "medtriad/services/stats-storage.ts"
      to: "AsyncStorage"
      via: "loadStats/saveStats with spread defaults"
      pattern: "categoryMastery.*Record.*TriadCategory"
    - from: "medtriad/hooks/useStats.ts"
      to: "medtriad/services/stats-storage.ts"
      via: "loadStats call"
      pattern: "categoryMastery"
---

<objective>
Add category mastery tracking to the stats storage layer and expose it through the useStats hook.

Purpose: Requirements CM-01 (track per-category) and CM-02 (persist locally) need a data foundation before the UI can display real category progress.

Output: StoredStats with categoryMastery field, updateAfterQuiz accepting category results, useStats exposing categoryMastery data.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-category-mastery/24-RESEARCH.md

@medtriad/services/stats-storage.ts
@medtriad/hooks/useStats.ts
@medtriad/types/triad.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add categoryMastery to StoredStats</name>
  <files>medtriad/services/stats-storage.ts</files>
  <action>
1. Import TriadCategory from @/types/triad at top of file

2. Add CategoryMasteryData interface after QuizHistoryEntry:
```typescript
export interface CategoryMasteryData {
  correct: number;
  total: number;
}
```

3. Add categoryMastery field to StoredStats interface (after pendingTierUp):
```typescript
categoryMastery: Record<TriadCategory, CategoryMasteryData>;
```

4. Add DEFAULT_CATEGORY_MASTERY constant before DEFAULT_STATS:
```typescript
const DEFAULT_CATEGORY_MASTERY: Record<TriadCategory, CategoryMasteryData> = {
  cardiology: { correct: 0, total: 0 },
  neurology: { correct: 0, total: 0 },
  endocrine: { correct: 0, total: 0 },
  pulmonary: { correct: 0, total: 0 },
  gastroenterology: { correct: 0, total: 0 },
  infectious: { correct: 0, total: 0 },
  hematology: { correct: 0, total: 0 },
  rheumatology: { correct: 0, total: 0 },
  renal: { correct: 0, total: 0 },
  obstetrics: { correct: 0, total: 0 },
};
```

5. Add categoryMastery to DEFAULT_STATS:
```typescript
categoryMastery: DEFAULT_CATEGORY_MASTERY,
```

6. Modify updateAfterQuiz signature to accept optional categoryResults parameter:
```typescript
export async function updateAfterQuiz(
  correctCount: number,
  totalQuestions: number,
  maxStreak: number,
  score: number,
  categoryResults?: Record<TriadCategory, CategoryMasteryData>
): Promise<StoredStats>
```

7. Inside updateAfterQuiz, after loading currentStats, merge category results:
```typescript
// Merge category results if provided
const mergedCategoryMastery = categoryResults
  ? Object.entries(categoryResults).reduce(
      (acc, [category, { correct, total }]) => {
        const current = currentStats.categoryMastery[category as TriadCategory] ?? { correct: 0, total: 0 };
        return {
          ...acc,
          [category]: {
            correct: current.correct + correct,
            total: current.total + total,
          },
        };
      },
      { ...currentStats.categoryMastery }
    )
  : currentStats.categoryMastery;
```

8. Add categoryMastery to updatedStats object (after pendingTierUp):
```typescript
categoryMastery: mergedCategoryMastery,
```

9. Export DEFAULT_CATEGORY_MASTERY for use in hook:
```typescript
export { DEFAULT_CATEGORY_MASTERY };
```

Note: The spread pattern in loadStats (`{ ...DEFAULT_STATS, ...JSON.parse(json) }`) already handles migration for existing users - they'll get DEFAULT_CATEGORY_MASTERY values automatically.
  </action>
  <verify>TypeScript compiles: `cd /Users/sannagranqvist/Documents/App/medtriad-app/medtriad && npx tsc --noEmit`</verify>
  <done>StoredStats has categoryMastery field, updateAfterQuiz accepts category results, defaults handle migration</done>
</task>

<task type="auto">
  <name>Task 2: Expose categoryMastery from useStats hook</name>
  <files>medtriad/hooks/useStats.ts</files>
  <action>
1. Import CategoryMasteryData and DEFAULT_CATEGORY_MASTERY from stats-storage:
```typescript
import {
  StoredStats,
  CategoryMasteryData,
  DEFAULT_CATEGORY_MASTERY,
  loadStats,
  updateAfterQuiz,
  getAccuracy,
  checkHighScore as checkHighScoreStorage,
  clearPendingTierUp as clearPendingTierUpStorage,
} from '@/services/stats-storage';
```

2. Import TriadCategory from types:
```typescript
import { TriadCategory } from '@/types/triad';
```

3. Add to StatsData interface (after checkHighScore):
```typescript
// Category mastery
categoryMastery: Record<TriadCategory, CategoryMasteryData>;
getCategoryPercent: (category: TriadCategory) => number;
```

4. Update recordQuizResult signature in interface:
```typescript
recordQuizResult: (
  correct: number,
  total: number,
  streak: number,
  score: number,
  categoryResults?: Record<TriadCategory, CategoryMasteryData>
) => Promise<void>;
```

5. Update recordQuizResult implementation to pass categoryResults:
```typescript
const recordQuizResult = useCallback(
  async (
    correct: number,
    total: number,
    streak: number,
    score: number,
    categoryResults?: Record<TriadCategory, CategoryMasteryData>
  ) => {
    const updated = await updateAfterQuiz(correct, total, streak, score, categoryResults);
    setStats(updated);
  },
  []
);
```

6. Add derived values before return statement (after pointsToNextTier calculation):
```typescript
// Category mastery
const categoryMastery = stats?.categoryMastery ?? DEFAULT_CATEGORY_MASTERY;

const getCategoryPercent = useCallback((category: TriadCategory): number => {
  const data = categoryMastery[category];
  if (!data || data.total === 0) return 0;
  return Math.round((data.correct / data.total) * 100);
}, [categoryMastery]);
```

7. Add to return object (after checkHighScore):
```typescript
// Category mastery
categoryMastery,
getCategoryPercent,
```
  </action>
  <verify>TypeScript compiles: `cd /Users/sannagranqvist/Documents/App/medtriad-app/medtriad && npx tsc --noEmit`</verify>
  <done>useStats returns categoryMastery data and getCategoryPercent helper function</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. StoredStats interface includes categoryMastery field
3. updateAfterQuiz accepts optional categoryResults parameter
4. useStats returns categoryMastery and getCategoryPercent
5. Existing imports of updateAfterQuiz (without categoryResults) still work (parameter is optional)
</verification>

<success_criteria>
- CategoryMasteryData type exported from stats-storage.ts
- StoredStats has categoryMastery: Record<TriadCategory, CategoryMasteryData>
- updateAfterQuiz accepts optional categoryResults parameter
- useStats.categoryMastery returns category data (defaults for new/existing users)
- useStats.getCategoryPercent(category) returns percentage (0-100)
- No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/24-category-mastery/24-01-SUMMARY.md`
</output>
