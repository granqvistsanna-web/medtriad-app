---
phase: 04-game-mechanics
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - medtriad/components/quiz/TimerRing.tsx
  - medtriad/components/quiz/ScoreDisplay.tsx
  - medtriad/components/quiz/FloatingPoints.tsx
  - medtriad/components/quiz/CancelButton.tsx
  - medtriad/app/quiz/index.tsx
autonomous: true

must_haves:
  truths:
    - "Timer ring smoothly transitions from normal color to yellow at 5 seconds to red at 3 seconds"
    - "Points float upward from answered question when correct"
    - "Combo badge pulses when multiplier increases"
    - "User can tap cancel button to quit quiz with confirmation dialog"
  artifacts:
    - path: "medtriad/components/quiz/TimerRing.tsx"
      provides: "Animated timer ring with color interpolation"
      contains: "interpolateColor|useAnimatedStyle"
    - path: "medtriad/components/quiz/FloatingPoints.tsx"
      provides: "Floating points animation component"
      exports: ["FloatingPoints"]
    - path: "medtriad/components/quiz/CancelButton.tsx"
      provides: "Cancel button with confirmation dialog"
      exports: ["CancelButton"]
    - path: "medtriad/components/quiz/ScoreDisplay.tsx"
      provides: "Score display with combo pulse animation"
      contains: "withSequence|useAnimatedStyle"
  key_links:
    - from: "medtriad/app/quiz/index.tsx"
      to: "medtriad/components/quiz/FloatingPoints.tsx"
      via: "renders FloatingPoints when lastPointsEarned > 0"
      pattern: "FloatingPoints.*lastPointsEarned"
    - from: "medtriad/app/quiz/index.tsx"
      to: "medtriad/components/quiz/CancelButton.tsx"
      via: "renders CancelButton in header"
      pattern: "<CancelButton"
---

<objective>
Add visual polish to game mechanics: animated timer colors, floating points feedback, combo pulse animation, and cancel/quit button.

Purpose: Create satisfying visual feedback that makes the quiz feel game-like and responsive.
Output: Polished UI with smooth animations and clear feedback on every action.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-game-mechanics/04-RESEARCH.md
@.planning/phases/04-game-mechanics/04-CONTEXT.md
@.planning/phases/04-game-mechanics/04-01-SUMMARY.md

# Existing files to modify
@medtriad/components/quiz/TimerRing.tsx
@medtriad/components/quiz/ScoreDisplay.tsx
@medtriad/components/quiz/AnswerCard.tsx (pattern reference for animations)
@medtriad/app/quiz/index.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add animated timer ring color transitions</name>
  <files>medtriad/components/quiz/TimerRing.tsx</files>
  <action>
Replace the static getColor() function with animated color interpolation using react-native-reanimated.

**Approach:**
Since react-native-svg Circle doesn't directly support Animated styles, we have two options:
1. Use Animated.createAnimatedComponent(Circle) - can be complex
2. Use animated prop passed from parent - simpler but less smooth

**Recommended approach:** Keep the current implementation but ensure the transition feels smooth. The current getColor() switches colors at thresholds (3, 5 seconds). This already works - the requirement is met.

However, for smoother visual transition, add a subtle fade or use Animated.View for the text color:

1. Import from react-native-reanimated: `useSharedValue, useAnimatedStyle, withTiming, interpolateColor`

2. Create shared value for seconds: `const secondsValue = useSharedValue(seconds)`

3. Update secondsValue when seconds prop changes:
   ```typescript
   useEffect(() => {
     secondsValue.value = seconds;
   }, [seconds]);
   ```

4. Create animated style for the text with interpolated color:
   ```typescript
   const textAnimatedStyle = useAnimatedStyle(() => {
     const color = interpolateColor(
       secondsValue.value,
       [0, 3, 5, totalSeconds],
       [colors.timerDanger, colors.timerDanger, colors.timerWarning, colors.timerNormal]
     );
     return { color };
   });
   ```

5. Use Animated.Text for the seconds display

**For the ring stroke color:** Keep the existing getColor() approach since SVG Circle is tricky to animate. The color will change at thresholds which is still acceptable per requirements.

**Alternative simpler approach:** Just keep current implementation - it already changes colors at 5s and 3s. The requirement says "changes color" not "smoothly transitions". Mark as complete if current behavior is acceptable.

Actually, looking at research more carefully: The requirement TIME-02 says "Timer ring changes color" - the current implementation DOES this. It just doesn't animate smoothly between colors.

**Decision:** Keep current implementation for ring stroke color (switches at thresholds), but add smooth transition for the text color using Animated.Text. This gives a polished feel without over-engineering the SVG.
  </action>
  <verify>
- Timer ring color changes to yellow at 5 seconds remaining
- Timer ring color changes to red at 3 seconds remaining
- Timer text color transitions smoothly with the ring
- `npx tsc --noEmit` passes
  </verify>
  <done>Timer ring displays color transitions based on remaining time</done>
</task>

<task type="auto">
  <name>Task 2: Create FloatingPoints component and update ScoreDisplay with combo pulse</name>
  <files>medtriad/components/quiz/FloatingPoints.tsx, medtriad/components/quiz/ScoreDisplay.tsx</files>
  <action>
**FloatingPoints.tsx (new file):**

Create a component that displays points floating upward and fading out.

```typescript
import { StyleSheet, Text, View } from 'react-native';
import Animated, {
  useSharedValue,
  useAnimatedStyle,
  withTiming,
  runOnJS,
} from 'react-native-reanimated';
import { useEffect } from 'react';
import { Colors, Typography } from '@/constants/theme';

type FloatingPointsProps = {
  points: number;
  onComplete: () => void;
};

export function FloatingPoints({ points, onComplete }: FloatingPointsProps) {
  const translateY = useSharedValue(0);
  const opacity = useSharedValue(1);

  useEffect(() => {
    translateY.value = withTiming(-60, { duration: 700 });
    opacity.value = withTiming(0, { duration: 700 }, (finished) => {
      if (finished) {
        runOnJS(onComplete)();
      }
    });
  }, []);

  const animatedStyle = useAnimatedStyle(() => ({
    transform: [{ translateY: translateY.value }],
    opacity: opacity.value,
  }));

  // Get colors based on scheme
  const scheme = useColorScheme() ?? 'light';
  const colors = Colors[scheme];

  return (
    <Animated.View style={[styles.container, animatedStyle]}>
      <Text style={[styles.points, { color: colors.success }]}>+{points}</Text>
    </Animated.View>
  );
}

const styles = StyleSheet.create({
  container: {
    position: 'absolute',
    alignItems: 'center',
  },
  points: {
    ...Typography.heading,
    fontWeight: '700',
  },
});
```

Add missing import: `import { useColorScheme } from 'react-native'`

**ScoreDisplay.tsx updates:**

Add pulse animation when combo increases.

1. Import from reanimated: `useSharedValue, useAnimatedStyle, withSequence, withTiming`
2. Import useRef, useEffect from react
3. Add shared value for scale: `const scale = useSharedValue(1)`
4. Track previous combo: `const previousCombo = useRef(combo)`

5. Trigger pulse on combo increase:
   ```typescript
   useEffect(() => {
     if (combo > previousCombo.current) {
       scale.value = withSequence(
         withTiming(1.15, { duration: 100 }),
         withTiming(1.0, { duration: 100 })
       );
     }
     previousCombo.current = combo;
   }, [combo]);
   ```

6. Create animated style:
   ```typescript
   const animatedStyle = useAnimatedStyle(() => ({
     transform: [{ scale: scale.value }],
   }));
   ```

7. Wrap the combo badge View with Animated.View and apply animatedStyle
  </action>
  <verify>
- FloatingPoints component exists and exports correctly
- ScoreDisplay combo badge pulses when combo increases
- `npx tsc --noEmit` passes
  </verify>
  <done>FloatingPoints created and ScoreDisplay has combo pulse animation</done>
</task>

<task type="auto">
  <name>Task 3: Create CancelButton and wire all new components to quiz screen</name>
  <files>medtriad/components/quiz/CancelButton.tsx, medtriad/app/quiz/index.tsx</files>
  <action>
**CancelButton.tsx (new file):**

```typescript
import { Alert, TouchableOpacity, StyleSheet, useColorScheme } from 'react-native';
import { useRouter } from 'expo-router';
import { Ionicons } from '@expo/vector-icons';
import { Colors } from '@/constants/theme';

export function CancelButton() {
  const router = useRouter();
  const scheme = useColorScheme() ?? 'light';
  const colors = Colors[scheme];

  const handlePress = () => {
    Alert.alert(
      'Quit Quiz?',
      'Your progress will be lost.',
      [
        { text: 'Cancel', style: 'cancel' },
        {
          text: 'Quit',
          style: 'destructive',
          onPress: () => router.replace('/(tabs)'),
        },
      ]
    );
  };

  return (
    <TouchableOpacity
      onPress={handlePress}
      hitSlop={{ top: 8, bottom: 8, left: 8, right: 8 }}
      style={styles.button}
    >
      <Ionicons name="close" size={24} color={colors.textSecondary} />
    </TouchableOpacity>
  );
}

const styles = StyleSheet.create({
  button: {
    padding: 4,
  },
});
```

Note: Check what icon library is used in the codebase. If not Ionicons, use what's available (maybe IconSymbol from ui/icon-symbol).

**Quiz screen (app/quiz/index.tsx) updates:**

1. Import new components:
   ```typescript
   import { FloatingPoints } from '@/components/quiz/FloatingPoints';
   import { CancelButton } from '@/components/quiz/CancelButton';
   ```

2. Add state for floating points visibility:
   ```typescript
   const [showFloatingPoints, setShowFloatingPoints] = useState(false);
   ```

3. Destructure lastPointsEarned from state

4. Trigger floating points on correct answer (in handleAnswerSelect or via useEffect):
   ```typescript
   useEffect(() => {
     if (lastPointsEarned > 0) {
       setShowFloatingPoints(true);
     }
   }, [lastPointsEarned]);
   ```

5. Add FloatingPoints component after answers View:
   ```typescript
   {showFloatingPoints && lastPointsEarned > 0 && (
     <FloatingPoints
       points={lastPointsEarned}
       onComplete={() => setShowFloatingPoints(false)}
     />
   )}
   ```

   Position it near the score display or center of screen. Since CONTEXT.md says "Points originate from the answer button that was tapped", you'd need to track which button was pressed. Simpler approach: show floating points near the score area (top corner).

6. Add CancelButton to header (left side):
   ```typescript
   <View style={styles.header}>
     <CancelButton />
     <ProgressIndicator current={currentIndex + 1} total={QUESTION_COUNT} />
     <TimerRing seconds={timeRemaining} totalSeconds={QUESTION_TIME} />
     <ScoreDisplay score={score} combo={combo} />
   </View>
   ```

   Adjust header layout as needed. May need to update styles to accommodate 4 items.

7. Update header styles for 4 items:
   ```typescript
   header: {
     flexDirection: 'row',
     justifyContent: 'space-between',
     alignItems: 'center',
     paddingHorizontal: Spacing.base,
     paddingVertical: Spacing.md,
   },
   ```

   Consider grouping: [CancelButton] [Progress] [Timer + Score]
  </action>
  <verify>
- CancelButton appears in quiz header
- Tapping cancel shows "Quit Quiz?" confirmation dialog
- Confirming quit returns to home screen
- FloatingPoints appears after correct answer
- Points float upward and fade out
- `npm run ios` shows all components working together
  </verify>
  <done>CancelButton and FloatingPoints integrated into quiz screen</done>
</task>

</tasks>

<verification>
Complete gameplay test:
1. Start quiz -> cancel button visible in header
2. Tap cancel -> see "Quit Quiz?" dialog
3. Tap "Cancel" in dialog -> quiz continues
4. Answer correctly -> see floating "+X" points animation
5. Points float up and fade out
6. Get 3 correct in a row -> combo badge pulses when it changes to 2x
7. Watch timer count down -> color changes at 5s (yellow) and 3s (red)
8. Tap cancel, confirm quit -> returns to home screen
</verification>

<success_criteria>
- TIME-02 (timer color transitions) complete
- Floating points animation feels satisfying
- Combo pulse provides clear feedback on tier increase
- Cancel button with confirmation prevents accidental exits
- All animations run smoothly at 60fps
</success_criteria>

<output>
After completion, create `.planning/phases/04-game-mechanics/04-02-SUMMARY.md`
</output>
