---
phase: 28-adaptive-difficulty
plan: 02
type: execute
wave: 2
depends_on: ["28-01"]
files_modified:
  - medtriad/services/question-generator.ts
  - medtriad/app/quiz/index.tsx
autonomous: true

must_haves:
  truths:
    - "Quiz Mode uses adaptive selection instead of random shuffle"
    - "User with weak Cardiology sees more Cardiology questions"
    - "Tricky-marked triads appear more frequently in quizzes"
    - "Higher-tier users receive proportionally harder triads"
  artifacts:
    - path: "medtriad/services/question-generator.ts"
      provides: "generateAdaptiveQuestionSet function"
      exports: ["generateAdaptiveQuestionSet"]
    - path: "medtriad/app/quiz/index.tsx"
      provides: "Quiz screen using adaptive selection"
      contains: "generateAdaptiveQuestionSet"
  key_links:
    - from: "medtriad/services/question-generator.ts"
      to: "medtriad/services/adaptive-selection.ts"
      via: "selectAdaptiveTriads import"
      pattern: "from.*adaptive-selection"
    - from: "medtriad/app/quiz/index.tsx"
      to: "medtriad/services/question-generator.ts"
      via: "generateAdaptiveQuestionSet call"
      pattern: "generateAdaptiveQuestionSet"
---

<objective>
Wire adaptive selection into the quiz flow, replacing random question generation with intelligent selection.

Purpose: Complete the adaptive difficulty feature by connecting the selection algorithms to the actual quiz experience.

Output: Quiz Mode now uses adaptive selection that prioritizes weak areas, tricky content, and adjusts for user tier.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-adaptive-difficulty/28-01-SUMMARY.md

# Integration targets
@medtriad/services/question-generator.ts
@medtriad/app/quiz/index.tsx
@medtriad/services/adaptive-selection.ts
@medtriad/services/mastery.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add generateAdaptiveQuestionSet to question-generator</name>
  <files>medtriad/services/question-generator.ts</files>
  <action>
Add new async function `generateAdaptiveQuestionSet` to question-generator.ts:

```typescript
/**
 * Generate a set of quiz questions using adaptive selection
 * Prioritizes weak categories, tricky items, and difficulty based on tier
 * @param count Number of questions to generate
 * @param userTier User's current tier (1-6)
 */
export async function generateAdaptiveQuestionSet(
  count: number,
  userTier: number
): Promise<QuizQuestion[]> {
  const selectedTriads = await selectAdaptiveTriads(count, userTier);
  return selectedTriads.map(triad => generateQuestion(triad));
}
```

Add import at top:
```typescript
import { selectAdaptiveTriads } from '@/services/adaptive-selection';
```

Keep existing `generateQuestionSet` function unchanged (for fallback and category-filtered modes).
  </action>
  <verify>
```bash
cd medtriad && npx tsc --noEmit
grep "generateAdaptiveQuestionSet" medtriad/services/question-generator.ts
```
  </verify>
  <done>
- generateAdaptiveQuestionSet exported from question-generator.ts
- Function calls selectAdaptiveTriads and maps to QuizQuestion[]
- Import from adaptive-selection.ts present
- TypeScript compiles
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire adaptive selection into Quiz screen</name>
  <files>medtriad/app/quiz/index.tsx</files>
  <action>
Modify quiz/index.tsx to use adaptive question generation:

1. Update import:
```typescript
import { generateAdaptiveQuestionSet } from '@/services/question-generator';
```

2. Replace sync initialization with async in the useEffect (around line 74):

**Before:**
```typescript
const generatedQuestions = generateQuestionSet(QUESTION_COUNT);
dispatch({ type: 'START_QUIZ', questions: generatedQuestions, questionTime });
```

**After:**
```typescript
// Use adaptive selection for quiz questions
generateAdaptiveQuestionSet(QUESTION_COUNT, currentTier.tier)
  .then((generatedQuestions) => {
    dispatch({ type: 'START_QUIZ', questions: generatedQuestions, questionTime });
  })
  .catch((error) => {
    console.error('Failed to generate adaptive questions, falling back to random:', error);
    // Fallback to random selection if adaptive fails
    const fallbackQuestions = generateQuestionSet(QUESTION_COUNT);
    dispatch({ type: 'START_QUIZ', questions: fallbackQuestions, questionTime });
  });
```

Note: Keep the existing `generateQuestionSet` import for the fallback path.

3. Ensure the import includes both functions:
```typescript
import { generateQuestionSet, generateAdaptiveQuestionSet } from '@/services/question-generator';
```

The fire-and-forget pattern with fallback ensures quiz always starts even if adaptive selection has issues (defensive coding).
  </action>
  <verify>
```bash
cd medtriad && npx tsc --noEmit
grep -A5 "generateAdaptiveQuestionSet" medtriad/app/quiz/index.tsx
```
  </verify>
  <done>
- Quiz screen imports generateAdaptiveQuestionSet
- Quiz initialization uses adaptive selection with fallback
- TypeScript compiles
- Quiz Mode now uses adaptive difficulty
  </done>
</task>

<task type="auto">
  <name>Task 3: Manual verification of adaptive behavior</name>
  <files></files>
  <action>
Create a simple verification script to confirm adaptive selection is working:

```bash
# Start the dev server if not running
cd medtriad && npx expo start --clear
```

Then manually test:
1. Open app in simulator
2. Play a few quiz rounds to generate performance data
3. Intentionally answer wrong on a specific category (e.g., Cardiology)
4. Mark some triads as "tricky" in Study Mode
5. Play another quiz round
6. Observe: Should see more questions from the weak category and tricky items

Note: Full automated testing of weighted distribution would require statistical analysis over many samples. For MVP, manual verification that the code path executes and questions load is sufficient.

Add a console.log in development to verify adaptive selection is being used:
In adaptive-selection.ts selectAdaptiveTriads, add at the end before return:
```typescript
if (__DEV__) {
  console.log('[Adaptive] Selected triads:', selectedTriads.map(t => t.id));
}
```

This helps verify the adaptive path is executing during manual testing.
  </action>
  <verify>
```bash
cd medtriad && npx tsc --noEmit
# App compiles and can start
cd medtriad && npx expo start --clear &
sleep 5
# If no errors, it's working
kill %1
```
  </verify>
  <done>
- App compiles without errors
- Dev server starts successfully
- Adaptive selection code path executes (verified via __DEV__ console.log)
- Quiz Mode loads questions (no crashes from async change)
  </done>
</task>

</tasks>

<verification>
```bash
# Full TypeScript check
cd medtriad && npx tsc --noEmit

# Verify integration points
grep "generateAdaptiveQuestionSet" medtriad/app/quiz/index.tsx
grep "selectAdaptiveTriads" medtriad/services/question-generator.ts

# App builds successfully
cd medtriad && npx expo export --platform ios 2>&1 | head -20
```
</verification>

<success_criteria>
- Quiz Mode uses generateAdaptiveQuestionSet (ADPT-01, ADPT-02, ADPT-03, ADPT-04)
- Fallback to random selection if adaptive fails (defensive)
- TypeScript compiles
- App runs and quiz loads questions
- User with poor category accuracy will see more questions from that category
- Tricky-marked triads will appear more frequently
- Higher-tier users receive proportionally harder triads
</success_criteria>

<output>
After completion, create `.planning/phases/28-adaptive-difficulty/28-02-SUMMARY.md`
</output>
