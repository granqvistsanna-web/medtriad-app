---
phase: 30-daily-challenges
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - medtriad/types/daily-challenge.ts
  - medtriad/services/daily-challenge.ts
  - medtriad/services/stats-storage.ts
autonomous: true

must_haves:
  truths:
    - "Daily challenge questions are deterministic based on date"
    - "User cannot complete same daily challenge twice in one day"
    - "Completing daily challenge increments streak"
    - "User earns streak freeze after completing 7 daily challenges in a week"
    - "Challenge type varies by day (speed, category, full)"
  artifacts:
    - path: "medtriad/types/daily-challenge.ts"
      provides: "DailyChallengeType, DailyChallengeState, StreakFreezeState types"
      exports: ["DailyChallengeType", "DailyChallengeState", "StreakFreezeState"]
    - path: "medtriad/services/daily-challenge.ts"
      provides: "Date-seeded question generation, completion tracking, challenge variant selection"
      exports: ["generateDailyChallenge", "getDailyChallengeState", "completeDailyChallenge", "getChallengeTypeForDate"]
    - path: "medtriad/services/stats-storage.ts"
      provides: "Streak freeze fields in StoredStats"
      contains: "streakFreezeCount"
  key_links:
    - from: "medtriad/services/daily-challenge.ts"
      to: "seedrandom"
      via: "npm import"
      pattern: "import.*seedrandom"
    - from: "medtriad/services/daily-challenge.ts"
      to: "medtriad/services/stats-storage.ts"
      via: "streak and completion persistence"
      pattern: "import.*stats-storage"
---

<objective>
Create the daily challenge foundation: types, date-seeded question generation, completion tracking, and streak freeze mechanics.

Purpose: Enable deterministic daily challenges that all users see the same questions for, with once-per-day completion enforcement and streak freeze rewards.
Output: Types and service files that power the daily challenge feature.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-daily-challenges/30-RESEARCH.md

# Existing services to integrate with
@medtriad/services/stats-storage.ts
@medtriad/services/question-generator.ts
@medtriad/utils/shuffle.ts
@medtriad/types/triad.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install seedrandom and create daily challenge types</name>
  <files>
    medtriad/types/daily-challenge.ts
    package.json
  </files>
  <action>
1. Install seedrandom library:
   ```bash
   npm install seedrandom @types/seedrandom
   ```

2. Create `medtriad/types/daily-challenge.ts` with:
   - `DailyChallengeType = 'speed' | 'category' | 'full'`
   - `DailyChallengeConfig` interface:
     - `type: DailyChallengeType`
     - `questionCount: number` (5 for speed, 10 for category/full)
     - `questionTime: number` (7 for speed, 15 for category/full)
     - `category?: TriadCategory` (only for category type)
     - `displayName: string` (e.g., "Speed Round", "Cardiology Focus", "Full Quiz")
   - `DailyChallengeState` interface:
     - `completedToday: boolean`
     - `completedAt: string | null` (ISO date string)
     - `challengeConfig: DailyChallengeConfig`
   - `StreakFreezeState` interface:
     - `count: number` (0 or 1, max 1 available)
     - `lastEarnedWeek: string | null` (ISO week string like "2026-W04")

Export all types.
  </action>
  <verify>
    - `npm install` completes without errors
    - `npx tsc --noEmit` passes
    - Types file exports DailyChallengeType, DailyChallengeConfig, DailyChallengeState, StreakFreezeState
  </verify>
  <done>Types defined and seedrandom installed, ready for service implementation</done>
</task>

<task type="auto">
  <name>Task 2: Create daily challenge service with date-seeded generation</name>
  <files>
    medtriad/services/daily-challenge.ts
    medtriad/services/stats-storage.ts
  </files>
  <action>
1. Update `medtriad/services/stats-storage.ts`:
   - Add to StoredStats interface:
     - `dailyChallengeCompletedDate: string | null` (ISO date-only: "2026-01-22")
     - `dailyChallengesCompletedThisWeek: number` (0-7, resets each week)
     - `weekStartDate: string | null` (ISO date of current week's Monday)
     - `streakFreezeCount: number` (0 or 1)
     - `streakFreezeLastEarnedWeek: string | null` (ISO week: "2026-W04")
   - Add defaults in DEFAULT_STATS: all null/0
   - Add helper `getISOWeek(date: Date): string` that returns "YYYY-Www" format
   - Add helper `getWeekStartDate(date: Date): string` that returns Monday's ISO date

2. Create `medtriad/services/daily-challenge.ts`:
   - Import seedrandom: `import seedrandom from 'seedrandom'`
   - Import from stats-storage, question-generator, triads

   **Date helpers:**
   - `getDateSeed(): string` - Returns today's date as "YYYY-MM-DD" using `new Date().toISOString().split('T')[0]`
   - `getCurrentWeek(): string` - Returns ISO week like "2026-W04"

   **Challenge type selection:**
   - `getChallengeTypeForDate(dateSeed?: string): DailyChallengeType`
     - Use seedrandom with dateSeed to get deterministic 0-2 value
     - Map: 0='speed', 1='category', 2='full'
     - 33/33/34% distribution

   **Category selection (for category type):**
   - `getCategoryForDate(dateSeed?: string): TriadCategory`
     - Use seedrandom with dateSeed + '-category' suffix
     - Pick from all 10 categories deterministically

   **Challenge config:**
   - `getDailyChallengeConfig(dateSeed?: string): DailyChallengeConfig`
     - Get type from getChallengeTypeForDate
     - Speed: questionCount=5, questionTime=7, displayName="Speed Round"
     - Category: questionCount=10, questionTime=15, category=getCategoryForDate(), displayName="{Category} Focus"
     - Full: questionCount=10, questionTime=15, displayName="Full Challenge"

   **Question generation:**
   - `generateDailyChallengeQuestions(config: DailyChallengeConfig, dateSeed?: string): QuizQuestion[]`
     - Use seedrandom with dateSeed for deterministic shuffle
     - If category type: filter triads by category, then seeded shuffle, take questionCount
     - Otherwise: seeded shuffle all triads, take questionCount
     - Generate questions using generateQuestion() for each selected triad

   **State management:**
   - `getDailyChallengeState(): Promise<DailyChallengeState>`
     - Load stats
     - Check if dailyChallengeCompletedDate matches today
     - Return completedToday, completedAt, and challengeConfig from getDailyChallengeConfig()

   - `completeDailyChallenge(): Promise<{ newStreak: number; earnedStreakFreeze: boolean; streakMilestone: number | null }>`
     - Load stats, verify not already completed today
     - Set dailyChallengeCompletedDate to today
     - Update streak using existing calculateStreak logic
     - Check if week changed - if so, reset dailyChallengesCompletedThisWeek to 0
     - Increment dailyChallengesCompletedThisWeek
     - If dailyChallengesCompletedThisWeek === 7 AND current week !== streakFreezeLastEarnedWeek:
       - Set streakFreezeCount = 1
       - Set streakFreezeLastEarnedWeek = current week
       - Set earnedStreakFreeze = true
     - Check streak milestones: if newStreak is exactly 7, 30, or 100, return streakMilestone
     - Save stats and return result

   **Streak freeze usage:**
   - `useStreakFreeze(): Promise<boolean>`
     - Load stats
     - If streakFreezeCount > 0 and streak would be lost (last played > 1 day ago):
       - Set streakFreezeCount = 0
       - Preserve dailyStreak (don't reset)
       - Save stats
       - Return true
     - Return false

   - `canUseStreakFreeze(): Promise<boolean>`
     - Check if streakFreezeCount > 0 AND would lose streak today
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Service exports all functions
    - Test manually: `getChallengeTypeForDate('2026-01-22')` returns same value on multiple calls
    - Test manually: Different dates return different types (try a few dates)
  </verify>
  <done>
    Daily challenge service complete with date-seeded generation, completion tracking, and streak freeze mechanics
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate streak freeze into streak calculation</name>
  <files>
    medtriad/services/stats-storage.ts
  </files>
  <action>
1. Update `calculateStreak()` in stats-storage.ts to accept optional streakFreezeCount parameter:
   ```typescript
   export function calculateStreak(
     currentStreak: number,
     lastPlayedDate: string | null,
     streakFreezeCount?: number
   ): { newStreak: number; isNewDay: boolean; usedStreakFreeze: boolean }
   ```

2. Modify the "streak broken" case:
   - If lastPlayedDate is more than 1 day ago (not yesterday, not today):
     - If streakFreezeCount > 0:
       - Return { newStreak: currentStreak, isNewDay: true, usedStreakFreeze: true }
     - Else:
       - Return { newStreak: 1, isNewDay: true, usedStreakFreeze: false }

3. Update `updateAfterQuiz()` to:
   - Pass streakFreezeCount to calculateStreak
   - If usedStreakFreeze is true:
     - Decrement streakFreezeCount in the updated stats
     - Log "Streak freeze used to preserve streak"

4. Add `getStreakFreezeCount(): Promise<number>` helper function that loads stats and returns streakFreezeCount.

5. Ensure backward compatibility: existing users without streakFreezeCount field get 0 via DEFAULT_STATS spread.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - calculateStreak signature updated with optional parameter
    - updateAfterQuiz correctly handles streak freeze consumption
  </verify>
  <done>
    Streak freeze integrated into existing streak calculation - playing any mode can use the freeze if needed
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit` passes
2. Deterministic test: Same date seed produces same challenge type and questions
3. Different dates produce different challenge types (verify with 3+ dates)
4. Stats storage schema extended with daily challenge fields
5. Streak freeze mechanics work: earn after 7 daily challenges, use to preserve streak
</verification>

<success_criteria>
- seedrandom installed and types created
- Daily challenge service generates deterministic questions from date seed
- Completion tracking prevents multiple completions per day
- Streak freeze earned after 7 daily challenges in a week
- Streak freeze consumed when streak would otherwise break
- All types exported and TypeScript compiles
</success_criteria>

<output>
After completion, create `.planning/phases/30-daily-challenges/30-01-SUMMARY.md`
</output>
