---
phase: 20-performance
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - medtriad/app/(tabs)/library.tsx
  - medtriad/components/library/TriadCard.tsx
autonomous: true

must_haves:
  truths:
    - "Library screen scrolls smoothly with 45+ items"
    - "Library screen initial render is fast (< 100ms)"
    - "Memory stays bounded during scroll (cell recycling)"
  artifacts:
    - path: "medtriad/app/(tabs)/library.tsx"
      provides: "Virtualized list with FlashList"
      contains: "FlashList"
    - path: "medtriad/components/library/TriadCard.tsx"
      provides: "Memoized card component"
      contains: "React.memo"
  key_links:
    - from: "medtriad/app/(tabs)/library.tsx"
      to: "FlashList"
      via: "import from @shopify/flash-list"
      pattern: "import.*FlashList.*@shopify/flash-list"
---

<objective>
Virtualize the Library screen list for smooth scrolling performance

Purpose: The Library screen currently uses ScrollView with .map() over 45 triads, rendering all items immediately. This causes slow initial render and unbounded memory growth. FlashList provides cell recycling and virtualization for 10x better performance.

Output: Library screen using FlashList with memoized TriadCard components
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-performance/20-RESEARCH.md

@medtriad/app/(tabs)/library.tsx
@medtriad/components/library/TriadCard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install FlashList dependency</name>
  <files>medtriad/package.json</files>
  <action>
Install @shopify/flash-list using Expo CLI:

```bash
cd medtriad && npx expo install @shopify/flash-list
```

This adds the FlashList dependency which provides virtualized list rendering with cell recycling.
  </action>
  <verify>
Run `cat medtriad/package.json | grep flash-list` - should show "@shopify/flash-list" in dependencies
  </verify>
  <done>FlashList package installed in medtriad/package.json</done>
</task>

<task type="auto">
  <name>Task 2: Convert Library to FlashList</name>
  <files>medtriad/app/(tabs)/library.tsx</files>
  <action>
Replace ScrollView with FlashList in library.tsx:

1. Add import: `import { FlashList } from '@shopify/flash-list'`

2. Replace the ScrollView section (lines ~90-131) with FlashList:

```typescript
<FlashList
  data={filteredTriads}
  renderItem={({ item, index }) => (
    <TriadCard
      triad={item}
      index={index}
      searchQuery={searchQuery}
    />
  )}
  estimatedItemSize={140}  // Approximate card height (content + gap)
  keyExtractor={(item) => item.id}
  contentContainerStyle={styles.content}
  showsVerticalScrollIndicator={false}
  keyboardShouldPersistTaps="handled"
  ListHeaderComponent={
    hasFilters && !showEmptyState ? (
      <Animated.View entering={FadeIn.duration(200)} style={styles.resultsHeader}>
        <Text style={[styles.resultsCount, { color: colors.textSecondary }]}>
          {filteredTriads.length} {filteredTriads.length === 1 ? 'result' : 'results'}
        </Text>
      </Animated.View>
    ) : null
  }
  ListEmptyComponent={
    showEmptyState ? (
      <Animated.View entering={FadeIn.duration(200)} style={styles.emptyState}>
        {/* ... existing empty state content ... */}
      </Animated.View>
    ) : null
  }
  ItemSeparatorComponent={() => <View style={{ height: Spacing.md }} />}
/>
```

3. Remove cardsContainer styles (gap handled by ItemSeparator)

4. Update content style - remove gap, keep padding

Key changes:
- FlashList requires `estimatedItemSize` for optimal performance
- Use `ListHeaderComponent` for results count (conditional)
- Use `ListEmptyComponent` for empty state
- Use `ItemSeparatorComponent` for gaps between items (cannot use gap in contentContainerStyle)
  </action>
  <verify>
Run the app with `npm start` in medtriad directory. Navigate to Library tab:
- Scroll should feel smooth
- Cards should render correctly
- Search and filter should work
- Empty state should display when no results
  </verify>
  <done>Library screen uses FlashList instead of ScrollView with .map()</done>
</task>

<task type="auto">
  <name>Task 3: Memoize TriadCard component</name>
  <files>medtriad/components/library/TriadCard.tsx</files>
  <action>
Wrap TriadCard with React.memo to prevent unnecessary re-renders during scroll:

1. Import React at top: `import React from 'react'` (if not already)

2. Convert the export to use React.memo:

```typescript
// Before
export function TriadCard({ triad, index, searchQuery = '' }: TriadCardProps) {
  // ... component code
}

// After
export const TriadCard = React.memo(function TriadCard({
  triad,
  index,
  searchQuery = '',
}: TriadCardProps) {
  // ... component code
});
```

Note: React Compiler is already enabled (may auto-memoize), but explicit memo provides a guaranteed optimization for FlashList item rendering. Only re-renders when triad, index, or searchQuery changes.
  </action>
  <verify>
Library screen still renders cards correctly. Scroll performance remains smooth.
  </verify>
  <done>TriadCard wrapped with React.memo for FlashList optimization</done>
</task>

</tasks>

<verification>
1. Run `cat medtriad/package.json | grep flash-list` - shows dependency
2. Run `grep -n "FlashList" medtriad/app/\(tabs\)/library.tsx` - shows FlashList usage
3. Run `grep -n "React.memo" medtriad/components/library/TriadCard.tsx` - shows memoization
4. Manual: Open app, navigate to Library, scroll through all 45 triads - should be smooth
5. Manual: Search for a term, results filter correctly
6. Manual: Select category filter, cards filter correctly
</verification>

<success_criteria>
- FlashList installed and used in Library screen
- TriadCard memoized with React.memo
- Library scrolls smoothly with 45+ items
- All existing functionality preserved (search, filter, empty state)
</success_criteria>

<output>
After completion, create `.planning/phases/20-performance/20-01-SUMMARY.md`
</output>
